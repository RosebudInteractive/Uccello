!function(window){function basicIndexOf(array,value,fromIndex){for(var index=(fromIndex||0)-1,length=array.length;++index<length;)if(array[index]===value)return index;return-1}function compareAscending(a,b){var ai=a.index,bi=b.index;if(a=a.criteria,b=b.criteria,a!==b){if(a>b||"undefined"==typeof a)return 1;if(b>a||"undefined"==typeof b)return-1}return bi>ai?-1:1}function escapeStringChar(match){return"\\"+stringEscapes[match]}function noop(){}function lodash(value){return value instanceof lodash?value:new lodashWrapper(value)}function lodashWrapper(value){this.__wrapped__=value}function createBound(func,thisArg,partialArgs,indicator){function bound(){var args=arguments,thisBinding=isPartial?this:thisArg;if(isFunc||(func=thisArg[key]),partialArgs.length&&(args=args.length?(args=nativeSlice.call(args),rightIndicator?args.concat(partialArgs):partialArgs.concat(args)):partialArgs),this instanceof bound){thisBinding=createObject(func.prototype);var result=func.apply(thisBinding,args);return isObject(result)?result:thisBinding}return func.apply(thisBinding,args)}var isFunc=isFunction(func),isPartial=!partialArgs,key=thisArg;if(isPartial){var rightIndicator=indicator;partialArgs=thisArg}else if(!isFunc){if(!indicator)throw new TypeError;thisArg=func}return bound}function createObject(prototype){return isObject(prototype)?nativeCreate(prototype):{}}function escapeHtmlChar(match){return htmlEscapes[match]}function getIndexOf(){var result=(result=lodash.indexOf)===indexOf?basicIndexOf:result;return result}function unescapeHtmlChar(match){return htmlUnescapes[match]}function isArguments(value){return toString.call(value)==argsClass}function assign(object){if(!object)return object;for(var argsIndex=1,argsLength=arguments.length;argsLength>argsIndex;argsIndex++){var iterable=arguments[argsIndex];if(iterable)for(var key in iterable)object[key]=iterable[key]}return object}function clone(value){return isObject(value)?isArray(value)?nativeSlice.call(value):assign({},value):value}function defaults(object){if(!object)return object;for(var argsIndex=1,argsLength=arguments.length;argsLength>argsIndex;argsIndex++){var iterable=arguments[argsIndex];if(iterable)for(var key in iterable)null==object[key]&&(object[key]=iterable[key])}return object}function functions(object){var result=[];return forIn(object,function(value,key){isFunction(value)&&result.push(key)}),result.sort()}function has(object,property){return object?hasOwnProperty.call(object,property):!1}function invert(object){for(var index=-1,props=keys(object),length=props.length,result={};++index<length;){var key=props[index];result[object[key]]=key}return result}function isBoolean(value){return value===!0||value===!1||toString.call(value)==boolClass}function isDate(value){return value?"object"==typeof value&&toString.call(value)==dateClass:!1}function isElement(value){return value?1===value.nodeType:!1}function isEmpty(value){if(!value)return!0;if(isArray(value)||isString(value))return!value.length;for(var key in value)if(hasOwnProperty.call(value,key))return!1;return!0}function isEqual(a,b,stackA,stackB){if(a===b)return 0!==a||1/a==1/b;var type=typeof a,otherType=typeof b;if(a===a&&(!a||"function"!=type&&"object"!=type)&&(!b||"function"!=otherType&&"object"!=otherType))return!1;if(null==a||null==b)return a===b;var className=toString.call(a),otherClass=toString.call(b);if(className!=otherClass)return!1;switch(className){case boolClass:case dateClass:return+a==+b;case numberClass:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case regexpClass:case stringClass:return a==String(b)}var isArr=className==arrayClass;if(!isArr){if(a instanceof lodash||b instanceof lodash)return isEqual(a.__wrapped__||a,b.__wrapped__||b,stackA,stackB);if(className!=objectClass)return!1;var ctorA=a.constructor,ctorB=b.constructor;if(ctorA!=ctorB&&!(isFunction(ctorA)&&ctorA instanceof ctorA&&isFunction(ctorB)&&ctorB instanceof ctorB))return!1}stackA||(stackA=[]),stackB||(stackB=[]);for(var length=stackA.length;length--;)if(stackA[length]==a)return stackB[length]==b;var result=!0,size=0;if(stackA.push(a),stackB.push(b),isArr){if(size=b.length,result=size==a.length)for(;size--&&(result=isEqual(a[size],b[size],stackA,stackB)););return result}return forIn(b,function(value,key,b){return hasOwnProperty.call(b,key)?(size++,!(result=hasOwnProperty.call(a,key)&&isEqual(a[key],value,stackA,stackB))&&indicatorObject):void 0}),result&&forIn(a,function(value,key,a){return hasOwnProperty.call(a,key)?!(result=--size>-1)&&indicatorObject:void 0}),result}function isFinite(value){return nativeIsFinite(value)&&!nativeIsNaN(parseFloat(value))}function isFunction(value){return"function"==typeof value}function isObject(value){return!(!value||!objectTypes[typeof value])}function isNaN(value){return isNumber(value)&&value!=+value}function isNull(value){return null===value}function isNumber(value){return"number"==typeof value||toString.call(value)==numberClass}function isRegExp(value){return!(!value||!objectTypes[typeof value])&&toString.call(value)==regexpClass}function isString(value){return"string"==typeof value||toString.call(value)==stringClass}function isUndefined(value){return"undefined"==typeof value}function omit(object){var indexOf=getIndexOf(),props=concat.apply(arrayRef,nativeSlice.call(arguments,1)),result={};return forIn(object,function(value,key){indexOf(props,key)<0&&(result[key]=value)}),result}function pairs(object){for(var index=-1,props=keys(object),length=props.length,result=Array(length);++index<length;){var key=props[index];result[index]=[key,object[key]]}return result}function pick(object){for(var index=-1,props=concat.apply(arrayRef,nativeSlice.call(arguments,1)),length=props.length,result={};++index<length;){var prop=props[index];prop in object&&(result[prop]=object[prop])}return result}function values(object){for(var index=-1,props=keys(object),length=props.length,result=Array(length);++index<length;)result[index]=object[props[index]];return result}function contains(collection,target){var indexOf=getIndexOf(),length=collection?collection.length:0,result=!1;return length&&"number"==typeof length?result=indexOf(collection,target)>-1:forOwn(collection,function(value){return(result=value===target)&&indicatorObject}),result}function countBy(collection,callback,thisArg){var result={};return callback=createCallback(callback,thisArg),forEach(collection,function(value,key,collection){key=String(callback(value,key,collection)),hasOwnProperty.call(result,key)?result[key]++:result[key]=1}),result}function every(collection,callback,thisArg){var result=!0;callback=createCallback(callback,thisArg);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length&&(result=!!callback(collection[index],index,collection)););else forOwn(collection,function(value,index,collection){return!(result=!!callback(value,index,collection))&&indicatorObject});return result}function filter(collection,callback,thisArg){var result=[];callback=createCallback(callback,thisArg);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length;){var value=collection[index];callback(value,index,collection)&&result.push(value)}else forOwn(collection,function(value,index,collection){callback(value,index,collection)&&result.push(value)});return result}function find(collection,callback,thisArg){callback=createCallback(callback,thisArg);var index=-1,length=collection?collection.length:0;if("number"!=typeof length){var result;return forOwn(collection,function(value,index,collection){return callback(value,index,collection)?(result=value,indicatorObject):void 0}),result}for(;++index<length;){var value=collection[index];if(callback(value,index,collection))return value}}function findWhere(object,properties){return where(object,properties,!0)}function forEach(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;if(callback=callback&&"undefined"==typeof thisArg?callback:createCallback(callback,thisArg),"number"==typeof length)for(;++index<length&&callback(collection[index],index,collection)!==indicatorObject;);else forOwn(collection,callback)}function groupBy(collection,callback,thisArg){var result={};return callback=createCallback(callback,thisArg),forEach(collection,function(value,key,collection){key=String(callback(value,key,collection)),(hasOwnProperty.call(result,key)?result[key]:result[key]=[]).push(value)}),result}function invoke(collection,methodName){var args=nativeSlice.call(arguments,2),index=-1,isFunc="function"==typeof methodName,length=collection?collection.length:0,result=Array("number"==typeof length?length:0);return forEach(collection,function(value){result[++index]=(isFunc?methodName:value[methodName]).apply(value,args)}),result}function map(collection,callback,thisArg){var index=-1,length=collection?collection.length:0;if(callback=createCallback(callback,thisArg),"number"==typeof length)for(var result=Array(length);++index<length;)result[index]=callback(collection[index],index,collection);else result=[],forOwn(collection,function(value,key,collection){result[++index]=callback(value,key,collection)});return result}function max(collection,callback,thisArg){var computed=-1/0,result=computed,index=-1,length=collection?collection.length:0;if(callback||"number"!=typeof length)callback=createCallback(callback,thisArg),forEach(collection,function(value,index,collection){var current=callback(value,index,collection);current>computed&&(computed=current,result=value)});else for(;++index<length;){var value=collection[index];value>result&&(result=value)}return result}function min(collection,callback,thisArg){var computed=1/0,result=computed,index=-1,length=collection?collection.length:0;if(callback||"number"!=typeof length)callback=createCallback(callback,thisArg),forEach(collection,function(value,index,collection){var current=callback(value,index,collection);computed>current&&(computed=current,result=value)});else for(;++index<length;){var value=collection[index];result>value&&(result=value)}return result}function pluck(collection,property){var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(var result=Array(length);++index<length;)result[index]=collection[index][property];return result||map(collection,property)}function reduce(collection,callback,accumulator,thisArg){if(!collection)return accumulator;var noaccum=arguments.length<3;callback=createCallback(callback,thisArg,4);var index=-1,length=collection.length;if("number"==typeof length)for(noaccum&&(accumulator=collection[++index]);++index<length;)accumulator=callback(accumulator,collection[index],index,collection);else forOwn(collection,function(value,index,collection){accumulator=noaccum?(noaccum=!1,value):callback(accumulator,value,index,collection)});return accumulator}function reduceRight(collection,callback,accumulator,thisArg){var iterable=collection,length=collection?collection.length:0,noaccum=arguments.length<3;if("number"!=typeof length){var props=keys(collection);length=props.length}return callback=createCallback(callback,thisArg,4),forEach(collection,function(value,index,collection){index=props?props[--length]:--length,accumulator=noaccum?(noaccum=!1,iterable[index]):callback(accumulator,iterable[index],index,collection)}),accumulator}function reject(collection,callback,thisArg){return callback=createCallback(callback,thisArg),filter(collection,function(value,index,collection){return!callback(value,index,collection)})}function shuffle(collection){var index=-1,length=collection?collection.length:0,result=Array("number"==typeof length?length:0);return forEach(collection,function(value){var rand=floor(nativeRandom()*(++index+1));result[index]=result[rand],result[rand]=value}),result}function size(collection){var length=collection?collection.length:0;return"number"==typeof length?length:keys(collection).length}function some(collection,callback,thisArg){var result;callback=createCallback(callback,thisArg);var index=-1,length=collection?collection.length:0;if("number"==typeof length)for(;++index<length&&!(result=callback(collection[index],index,collection)););else forOwn(collection,function(value,index,collection){return(result=callback(value,index,collection))&&indicatorObject});return!!result}function sortBy(collection,callback,thisArg){var index=-1,length=collection?collection.length:0,result=Array("number"==typeof length?length:0);for(callback=createCallback(callback,thisArg),forEach(collection,function(value,key,collection){result[++index]={criteria:callback(value,key,collection),index:index,value:value}}),length=result.length,result.sort(compareAscending);length--;)result[length]=result[length].value;return result}function toArray(collection){return isArray(collection)?nativeSlice.call(collection):collection&&"number"==typeof collection.length?map(collection):values(collection)}function where(collection,properties,first){return first&&isEmpty(properties)?null:(first?find:filter)(collection,properties)}function compact(array){for(var index=-1,length=array?array.length:0,result=[];++index<length;){var value=array[index];value&&result.push(value)}return result}function difference(array){for(var index=-1,indexOf=getIndexOf(),length=array.length,flattened=concat.apply(arrayRef,nativeSlice.call(arguments,1)),result=[];++index<length;){var value=array[index];indexOf(flattened,value)<0&&result.push(value)}return result}function first(array,callback,thisArg){if(array){var n=0,length=array.length;if("number"!=typeof callback&&null!=callback){var index=-1;for(callback=createCallback(callback,thisArg);++index<length&&callback(array[index],index,array);)n++}else if(n=callback,null==n||thisArg)return array[0];return nativeSlice.call(array,0,nativeMin(nativeMax(0,n),length))}}function flatten(array,isShallow){for(var index=-1,length=array?array.length:0,result=[];++index<length;){var value=array[index];isArray(value)?push.apply(result,isShallow?value:flatten(value)):result.push(value)}return result}function indexOf(array,value,fromIndex){if("number"==typeof fromIndex){var length=array?array.length:0;fromIndex=0>fromIndex?nativeMax(0,length+fromIndex):fromIndex||0}else if(fromIndex){var index=sortedIndex(array,value);return array[index]===value?index:-1}return array?basicIndexOf(array,value,fromIndex):-1}function initial(array,callback,thisArg){if(!array)return[];var n=0,length=array.length;if("number"!=typeof callback&&null!=callback){var index=length;for(callback=createCallback(callback,thisArg);index--&&callback(array[index],index,array);)n++}else n=null==callback||thisArg?1:callback||n;return nativeSlice.call(array,0,nativeMin(nativeMax(0,length-n),length))}function intersection(array){var args=arguments,argsLength=args.length,index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[];outer:for(;++index<length;){var value=array[index];if(indexOf(result,value)<0){for(var argsIndex=argsLength;--argsIndex;)if(indexOf(args[argsIndex],value)<0)continue outer;result.push(value)}}return result}function last(array,callback,thisArg){if(array){var n=0,length=array.length;if("number"!=typeof callback&&null!=callback){var index=length;for(callback=createCallback(callback,thisArg);index--&&callback(array[index],index,array);)n++}else if(n=callback,null==n||thisArg)return array[length-1];return nativeSlice.call(array,nativeMax(0,length-n))}}function lastIndexOf(array,value,fromIndex){var index=array?array.length:0;for("number"==typeof fromIndex&&(index=(0>fromIndex?nativeMax(0,index+fromIndex):nativeMin(fromIndex,index-1))+1);index--;)if(array[index]===value)return index;return-1}function range(start,end,step){start=+start||0,step=+step||1,null==end&&(end=start,start=0);for(var index=-1,length=nativeMax(0,ceil((end-start)/step)),result=Array(length);++index<length;)result[index]=start,start+=step;return result}function rest(array,callback,thisArg){if("number"!=typeof callback&&null!=callback){var n=0,index=-1,length=array?array.length:0;for(callback=createCallback(callback,thisArg);++index<length&&callback(array[index],index,array);)n++}else n=null==callback||thisArg?1:nativeMax(0,callback);return nativeSlice.call(array,n)}function sortedIndex(array,value,callback,thisArg){var low=0,high=array?array.length:low;for(callback=callback?createCallback(callback,thisArg,1):identity,value=callback(value);high>low;){var mid=low+high>>>1;callback(array[mid])<value?low=mid+1:high=mid}return low}function union(array){return isArray(array)||(arguments[0]=array?nativeSlice.call(array):arrayRef),uniq(concat.apply(arrayRef,arguments))}function uniq(array,isSorted,callback,thisArg){var index=-1,indexOf=getIndexOf(),length=array?array.length:0,result=[],seen=result;for("boolean"!=typeof isSorted&&null!=isSorted&&(thisArg=callback,callback=isSorted,isSorted=!1),null!=callback&&(seen=[],callback=createCallback(callback,thisArg));++index<length;){var value=array[index],computed=callback?callback(value,index,array):value;(isSorted?!index||seen[seen.length-1]!==computed:indexOf(seen,computed)<0)&&(callback&&seen.push(computed),result.push(value))}return result}function without(array){return difference(array,nativeSlice.call(arguments,1))}function zip(array){for(var index=-1,length=array?max(pluck(arguments,"length")):0,result=Array(0>length?0:length);++index<length;)result[index]=pluck(arguments,index);return result}function zipObject(keys,values){for(var index=-1,length=keys?keys.length:0,result={};++index<length;){var key=keys[index];values?result[key]=values[index]:result[key[0]]=key[1]}return result}function after(n,func){return 1>n?func():function(){return--n<1?func.apply(this,arguments):void 0}}function bind(func,thisArg){return support.fastBind||nativeBind&&arguments.length>2?nativeBind.call.apply(nativeBind,arguments):createBound(func,thisArg,nativeSlice.call(arguments,2))}function bindAll(object){for(var funcs=arguments.length>1?concat.apply(arrayRef,nativeSlice.call(arguments,1)):functions(object),index=-1,length=funcs.length;++index<length;){var key=funcs[index];object[key]=bind(object[key],object)}return object}function compose(){var funcs=arguments;return function(){for(var args=arguments,length=funcs.length;length--;)args=[funcs[length].apply(this,args)];return args[0]}}function createCallback(func,thisArg,argCount){if(null==func)return identity;var type=typeof func;if("function"!=type){if("object"!=type)return function(object){return object[func]};var props=keys(func);return function(object){for(var length=props.length,result=!1;length--&&(result=object[props[length]]===func[props[length]]););return result}}return"undefined"==typeof thisArg?func:1===argCount?function(value){return func.call(thisArg,value)}:2===argCount?function(a,b){return func.call(thisArg,a,b)}:4===argCount?function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)}:function(value,index,collection){return func.call(thisArg,value,index,collection)}}function debounce(func,wait,immediate){function delayed(){timeoutId=null,immediate||(result=func.apply(thisArg,args))}var args,result,thisArg,timeoutId=null;return function(){var isImmediate=immediate&&!timeoutId;return args=arguments,thisArg=this,clearTimeout(timeoutId),timeoutId=setTimeout(delayed,wait),isImmediate&&(result=func.apply(thisArg,args)),result}}function defer(func){var args=nativeSlice.call(arguments,1);return setTimeout(function(){func.apply(undefined,args)},1)}function delay(func,wait){var args=nativeSlice.call(arguments,2);return setTimeout(function(){func.apply(undefined,args)},wait)}function memoize(func,resolver){var cache={};return function(){var key=keyPrefix+(resolver?resolver.apply(this,arguments):arguments[0]);return hasOwnProperty.call(cache,key)?cache[key]:cache[key]=func.apply(this,arguments)}}function once(func){var ran,result;return function(){return ran?result:(ran=!0,result=func.apply(this,arguments),func=null,result)}}function partial(func){return createBound(func,nativeSlice.call(arguments,1))}function throttle(func,wait){function trailingCall(){lastCalled=new Date,timeoutId=null,result=func.apply(thisArg,args)}var args,result,thisArg,lastCalled=0,timeoutId=null;return function(){var now=new Date,remaining=wait-(now-lastCalled);return args=arguments,thisArg=this,0>=remaining?(clearTimeout(timeoutId),timeoutId=null,lastCalled=now,result=func.apply(thisArg,args)):timeoutId||(timeoutId=setTimeout(trailingCall,remaining)),result}}function wrap(value,wrapper){return function(){var args=[value];return push.apply(args,arguments),wrapper.apply(this,args)}}function escape(string){return null==string?"":String(string).replace(reUnescapedHtml,escapeHtmlChar)}function identity(value){return value}function mixin(object){forEach(functions(object),function(methodName){var func=lodash[methodName]=object[methodName];lodash.prototype[methodName]=function(){var args=[this.__wrapped__];push.apply(args,arguments);var result=func.apply(lodash,args);return this.__chain__&&(result=new lodashWrapper(result),result.__chain__=!0),result}})}function noConflict(){return window._=oldDash,this}function random(min,max){null==min&&null==max&&(max=1),min=+min||0,null==max?(max=min,min=0):max=+max||0;var rand=nativeRandom();return min%1||max%1?min+nativeMin(rand*(max-min+parseFloat("1e-"+((rand+"").length-1))),max):min+floor(rand*(max-min+1))}function result(object,property){var value=object?object[property]:null;return isFunction(value)?object[property]():value}function template(text,data,options){var settings=lodash.templateSettings;text||(text=""),options=defaults({},options,settings);var index=0,source="__p += '",variable=options.variable,reDelimiters=RegExp((options.escape||reNoMatch).source+"|"+(options.interpolate||reNoMatch).source+"|"+(options.evaluate||reNoMatch).source+"|$","g");text.replace(reDelimiters,function(match,escapeValue,interpolateValue,evaluateValue,offset){return source+=text.slice(index,offset).replace(reUnescapedString,escapeStringChar),escapeValue&&(source+="' +\n_.escape("+escapeValue+") +\n'"),evaluateValue&&(source+="';\n"+evaluateValue+";\n__p += '"),interpolateValue&&(source+="' +\n((__t = ("+interpolateValue+")) == null ? '' : __t) +\n'"),index=offset+match.length,match}),source+="';\n",variable||(variable="obj",source="with ("+variable+" || {}) {\n"+source+"\n}\n"),source="function("+variable+") {\nvar __t, __p = '', __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n"+source+"return __p\n}";try{var result=Function("_","return "+source)(lodash)}catch(e){throw e.source=source,e}return data?result(data):(result.source=source,result)}function times(n,callback,thisArg){for(var index=-1,result=Array(n>-1?n:0);++index<n;)result[index]=callback.call(thisArg,index);return result}function unescape(string){return null==string?"":String(string).replace(reEscapedHtml,unescapeHtmlChar)}function uniqueId(prefix){var id=++idCounter+"";return prefix?prefix+id:id}function chain(value){return value=new lodashWrapper(value),value.__chain__=!0,value}function tap(value,interceptor){return interceptor(value),value}function wrapperChain(){return this.__chain__=!0,this}function wrapperValueOf(){return this.__wrapped__}var undefined,idCounter=0,indicatorObject={},keyPrefix=+new Date+"",reEscapedHtml=/&(?:amp|lt|gt|quot|#39);/g,reInterpolate=/<%=([\s\S]+?)%>/g,reNoMatch=/($^)/,reUnescapedHtml=/[&<>"']/g,reUnescapedString=/['\n\r\t\u2028\u2029\\]/g,argsClass="[object Arguments]",arrayClass="[object Array]",boolClass="[object Boolean]",dateClass="[object Date]",funcClass="[object Function]",numberClass="[object Number]",objectClass="[object Object]",regexpClass="[object RegExp]",stringClass="[object String]",objectTypes={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},stringEscapes={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},freeExports=objectTypes[typeof exports]&&exports,freeModule=objectTypes[typeof module]&&module&&module.exports==freeExports&&module,freeGlobal=objectTypes[typeof global]&&global;!freeGlobal||freeGlobal.global!==freeGlobal&&freeGlobal.window!==freeGlobal||(window=freeGlobal);var arrayRef=[],objectProto=Object.prototype,oldDash=(String.prototype,window._),reNative=RegExp("^"+String(objectProto.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),ceil=Math.ceil,clearTimeout=window.clearTimeout,concat=arrayRef.concat,floor=Math.floor,hasOwnProperty=objectProto.hasOwnProperty,push=arrayRef.push,setTimeout=(objectProto.propertyIsEnumerable,window.setTimeout),toString=objectProto.toString,nativeBind=reNative.test(nativeBind=toString.bind)&&nativeBind,nativeCreate=reNative.test(nativeCreate=Object.create)&&nativeCreate,nativeIsArray=reNative.test(nativeIsArray=Array.isArray)&&nativeIsArray,nativeIsFinite=window.isFinite,nativeIsNaN=window.isNaN,nativeKeys=reNative.test(nativeKeys=Object.keys)&&nativeKeys,nativeMax=Math.max,nativeMin=Math.min,nativeRandom=Math.random,nativeSlice=arrayRef.slice,isIeOpera=reNative.test(window.attachEvent),isV8=nativeBind&&!/\n|true/.test(nativeBind+isIeOpera);lodashWrapper.prototype=lodash.prototype;var support={};if(function(){var object={0:1,length:1};support.fastBind=nativeBind&&!isV8,support.spliceObjects=(arrayRef.splice.call(object,0,1),!object[0])}(1),lodash.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:reInterpolate,variable:""},!nativeCreate)var createObject=function(prototype){if(isObject(prototype)){noop.prototype=prototype;var result=new noop;noop.prototype=null}return result||{}};isArguments(arguments)||(isArguments=function(value){return value?hasOwnProperty.call(value,"callee"):!1});var isArray=nativeIsArray||function(value){return value?"object"==typeof value&&toString.call(value)==arrayClass:!1},shimKeys=function(object){var index,iterable=object,result=[];if(!iterable)return result;if(!objectTypes[typeof object])return result;for(index in iterable)hasOwnProperty.call(iterable,index)&&result.push(index);return result},keys=nativeKeys?function(object){return isObject(object)?nativeKeys(object):[]}:shimKeys,htmlEscapes={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},htmlUnescapes=invert(htmlEscapes),forIn=function(collection,callback){var index,iterable=collection,result=iterable;if(!iterable)return result;if(!objectTypes[typeof iterable])return result;for(index in iterable)if(callback(iterable[index],index,collection)===indicatorObject)return result;return result},forOwn=function(collection,callback){var index,iterable=collection,result=iterable;if(!iterable)return result;if(!objectTypes[typeof iterable])return result;for(index in iterable)if(hasOwnProperty.call(iterable,index)&&callback(iterable[index],index,collection)===indicatorObject)return result;return result};isFunction(/x/)&&(isFunction=function(value){return"function"==typeof value&&toString.call(value)==funcClass}),lodash.after=after,lodash.bind=bind,lodash.bindAll=bindAll,lodash.compact=compact,lodash.compose=compose,lodash.countBy=countBy,lodash.debounce=debounce,lodash.defaults=defaults,lodash.defer=defer,lodash.delay=delay,lodash.difference=difference,lodash.filter=filter,lodash.flatten=flatten,lodash.forEach=forEach,lodash.functions=functions,lodash.groupBy=groupBy,lodash.initial=initial,lodash.intersection=intersection,lodash.invert=invert,lodash.invoke=invoke,lodash.keys=keys,lodash.map=map,lodash.max=max,lodash.memoize=memoize,lodash.min=min,lodash.omit=omit,lodash.once=once,lodash.pairs=pairs,lodash.partial=partial,lodash.pick=pick,lodash.pluck=pluck,lodash.range=range,lodash.reject=reject,lodash.rest=rest,lodash.shuffle=shuffle,lodash.sortBy=sortBy,lodash.tap=tap,lodash.throttle=throttle,lodash.times=times,lodash.toArray=toArray,lodash.union=union,lodash.uniq=uniq,lodash.values=values,lodash.where=where,lodash.without=without,lodash.wrap=wrap,lodash.zip=zip,lodash.collect=map,lodash.drop=rest,lodash.each=forEach,lodash.extend=assign,lodash.methods=functions,lodash.object=zipObject,lodash.select=filter,lodash.tail=rest,lodash.unique=uniq,lodash.chain=chain,lodash.clone=clone,lodash.contains=contains,lodash.escape=escape,lodash.every=every,lodash.find=find,lodash.has=has,lodash.identity=identity,lodash.indexOf=indexOf,lodash.isArguments=isArguments,lodash.isArray=isArray,lodash.isBoolean=isBoolean,lodash.isDate=isDate,lodash.isElement=isElement,lodash.isEmpty=isEmpty,lodash.isEqual=isEqual,lodash.isFinite=isFinite,lodash.isFunction=isFunction,lodash.isNaN=isNaN,lodash.isNull=isNull,lodash.isNumber=isNumber,lodash.isObject=isObject,lodash.isRegExp=isRegExp,lodash.isString=isString,lodash.isUndefined=isUndefined,lodash.lastIndexOf=lastIndexOf,lodash.mixin=mixin,lodash.noConflict=noConflict,lodash.random=random,lodash.reduce=reduce,lodash.reduceRight=reduceRight,lodash.result=result,lodash.size=size,lodash.some=some,lodash.sortedIndex=sortedIndex,lodash.template=template,lodash.unescape=unescape,lodash.uniqueId=uniqueId,lodash.all=every,lodash.any=some,lodash.detect=find,lodash.findWhere=findWhere,lodash.foldl=reduce,lodash.foldr=reduceRight,lodash.include=contains,lodash.inject=reduce,lodash.first=first,lodash.last=last,lodash.take=first,lodash.head=first,lodash.VERSION="1.3.1",mixin(lodash),lodash.prototype.chain=wrapperChain,lodash.prototype.value=wrapperValueOf,forEach(["pop","push","reverse","shift","sort","splice","unshift"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){var value=this.__wrapped__;return func.apply(value,arguments),support.spliceObjects||0!==value.length||delete value[0],this}}),forEach(["concat","join","slice"],function(methodName){var func=arrayRef[methodName];lodash.prototype[methodName]=function(){var value=this.__wrapped__,result=func.apply(value,arguments);return this.__chain__&&(result=new lodashWrapper(result),result.__chain__=!0),result}}),"function"==typeof define&&"object"==typeof define.amd&&define.amd?(window._=lodash,"function"==typeof define&&define.amd&&define("underscore",[],function(){return lodash})):freeExports&&!freeExports.nodeType?freeModule?(freeModule.exports=lodash)._=lodash:freeExports._=lodash:window._=lodash}(this),define("text",["module"],function(module){var text,fs,Cc,Ci,xpcIsWindows,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation="undefined"!=typeof location&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||void 0),buildMap={},masterConfig=module.config&&module.config()||{};return text={version:"2.0.12",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);matches&&(content=matches[1])}else content="";return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:masterConfig.createXhr||function(){var xhr,i,progId;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(i=0;3>i;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}return xhr},parseName:function(name){var modName,ext,temp,strip=!1,index=name.indexOf("."),isRelative=0===name.indexOf("./")||0===name.indexOf("../");return-1!==index&&(!isRelative||index>1)?(modName=name.substring(0,index),ext=name.substring(index+1,name.length)):modName=name,temp=ext||modName,index=temp.indexOf("!"),-1!==index&&(strip="strip"===temp.substring(index+1),temp=temp.substring(0,index),ext?ext=temp:modName=temp),{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var uProtocol,uHostName,uPort,match=text.xdRegExp.exec(url);
return match?(uProtocol=match[2],uHostName=match[3],uHostName=uHostName.split(":"),uPort=uHostName[1],uHostName=uHostName[0],!(uProtocol&&uProtocol!==protocol||uHostName&&uHostName.toLowerCase()!==hostname.toLowerCase()||(uPort||uHostName)&&uPort!==port)):!0},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content,masterConfig.isBuild&&(buildMap[name]=content),onLoad(content)},load:function(name,req,onLoad,config){if(config&&config.isBuild&&!config.inlineText)return void onLoad();masterConfig.isBuild=config&&config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+(parsed.ext?"."+parsed.ext:""),url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;return 0===url.indexOf("empty:")?void onLoad():void(!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)?text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){onLoad.error&&onLoad.error(err)}):req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)}))},write:function(pluginName,moduleName,write){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),extPart=parsed.ext?"."+parsed.ext:"",nonStripName=parsed.moduleName+extPart,fileName=req.toUrl(parsed.moduleName+extPart)+".js";text.load(nonStripName,req,function(){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)},text.write(pluginName,nonStripName,textWrite,config)},config)}},"node"===masterConfig.env||!masterConfig.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(fs=require.nodeRequire("fs"),text.get=function(url,callback,errback){try{var file=fs.readFileSync(url,"utf8");0===file.indexOf("ï»¿")&&(file=file.substring(1)),callback(file)}catch(e){errback&&errback(e)}}):"xhr"===masterConfig.env||!masterConfig.env&&text.createXhr()?text.get=function(url,callback,errback,headers){var header,xhr=text.createXhr();if(xhr.open("GET",url,!0),headers)for(header in headers)headers.hasOwnProperty(header)&&xhr.setRequestHeader(header.toLowerCase(),headers[header]);masterConfig.onXhr&&masterConfig.onXhr(xhr,url),xhr.onreadystatechange=function(){var status,err;4===xhr.readyState&&(status=xhr.status||0,status>399&&600>status?(err=new Error(url+" HTTP status: "+status),err.xhr=xhr,errback&&errback(err)):callback(xhr.responseText),masterConfig.onXhrComplete&&masterConfig.onXhrComplete(xhr,url))},xhr.send(null)}:"rhino"===masterConfig.env||!masterConfig.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?text.get=function(url,callback){var stringBuffer,line,encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),content="";try{for(stringBuffer=new java.lang.StringBuffer,line=input.readLine(),line&&line.length()&&65279===line.charAt(0)&&(line=line.substring(1)),null!==line&&stringBuffer.append(line);null!==(line=input.readLine());)stringBuffer.append(lineSeparator),stringBuffer.append(line);content=String(stringBuffer.toString())}finally{input.close()}callback(content)}:("xpconnect"===masterConfig.env||!masterConfig.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(Cc=Components.classes,Ci=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),xpcIsWindows="@mozilla.org/windows-registry-key;1"in Cc,text.get=function(url,callback){var inStream,convertStream,fileObj,readData={};xpcIsWindows&&(url=url.replace(/\//g,"\\")),fileObj=new FileUtils.File(url);try{inStream=Cc["@mozilla.org/network/file-input-stream;1"].createInstance(Ci.nsIFileInputStream),inStream.init(fileObj,1,0,!1),convertStream=Cc["@mozilla.org/intl/converter-input-stream;1"].createInstance(Ci.nsIConverterInputStream),convertStream.init(inStream,"utf-8",inStream.available(),Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),convertStream.readString(inStream.available(),readData),convertStream.close(),inStream.close(),callback(readData.value)}catch(e){throw new Error((fileObj&&fileObj.path||"")+": "+e)}}),text}),define("template",["underscore"],function(_){var CTemplate=Class.extend({init:function(){},parseTemplate:function(template){var i,name,names,regEx,templateBodies,templateBody,templateName,templates;return regEx=/\<\!--\s+?template:\s+?(.+)\s?--\>/gi,templates={},templateBodies=_.compact(function(){var _i,_len,_ref,_results;for(_ref=template.split(/\<\!--\s+?template:\s+?.+\s?--\>/gi),_results=[],i=_i=0,_len=_ref.length;_len>_i;i=++_i)templateBody=_ref[i],_results.push($.trim(templateBody));return _results}()),names=function(){var _i,_len,_ref,_results;for(_ref=template.match(regEx),_results=[],i=_i=0,_len=_ref.length;_len>_i;i=++_i)templateName=_ref[i],name=templateName.replace(/(<\!--\s+?template:\s+?)|(\s+?-->)/gi,""),null!=templates[name]&&console.error("Templates collision: two equal names"),_results.push(templates[name]=templateBodies[i]||"");return _results}(),templates},template:function(tmpl,params){return _.template(tmpl,params)}});return new CTemplate}),define("config/config",[],function(){var config=Class.extend({controls:[{className:"DataControl",isUccello:!0,component:"controls/aDataControl"},{className:"DataFieldControl",isUccello:!0,component:"controls/aDataFieldControl"},{className:"DataRoot",isUccello:!0,component:"dataman/dataRoot"},{className:"ADataModel",isUccello:!0,component:"controls/aDataModel"},{className:"DataField",isUccello:!0,component:"controls/dataField"},{className:"Dataset",isUccello:!0,component:"controls/dataset"},{className:"FormParam",isUccello:!0,component:"controls/formParam"},{className:"SubForm",isUccello:!0,component:"controls/subForm"},{className:"Container",isUccello:!0,component:"controls/container",viewset:!1},{className:"Form",isUccello:!0,component:"controls/form",viewset:!1},{className:"Button",isUccello:!0,component:"controls/button",viewset:!1},{className:"DataColumn",isUccello:!0,component:"controls/dataColumn"},{className:"DataGrid",isUccello:!0,component:"controls/dataGrid",viewset:!1},{className:"DataEdit",isUccello:!0,component:"controls/dataEdit",viewset:!1},{className:"Edit",isUccello:!0,component:"controls/edit",viewset:!1},{className:"Label",isUccello:!0,component:"controls/label",viewset:!1}],guids:{sysDB:"fb41702c-faba-b5c0-63a8-8d553bfe54a6"},classGuids:{ClientConnection:"5f27198a-0dd2-81b1-3eeb-2834b93fb514",Connect:"66105954-4149-1491-1425-eac17fbe5a72",ConnectInfo:"42dbc6c0-f8e4-80a5-a95f-e43601cccc71",Session:"70c9ac53-6fe5-18d1-7d64-45cfff65dbbb",SessionInfo:"479c72e9-29d1-3d6b-b17b-f5bf02e52002",User:"dccac4fc-c50b-ed17-6da7-1f6230b5b055",UserInfo:"e14cad9b-3895-3dc9-91ef-1fb12c343f10",AComponent:"5b8c93e7-350d-de2a-e2b4-1025a03b17db",AControl:"c576cb6e-cdbc-50f4-91d1-4dc3b48b0b59",ADataControl:"b2c132fd-c6bc-b3c7-d149-27a926916216",ADataFieldControl:"00a12976-6fe3-6592-1984-635684b30885",ADataModel:"5e89f6c7-ccc2-a850-2f67-b5f5f20c3d47",DataField:"4bade3a6-4a25-3887-4868-9c3de4213729",Dataset:"3f3341c7-2f06-8d9d-4099-1075c158aeee",FormParam:"4943ce3e-a6cb-65f7-8805-ec339555a981",SubForm:"d7785c24-0b96-76ee-46a7-b0103cda4aa0",DataRoot:"87510077-53d2-00b3-0032-f1245ab1b74d",Label:"32932036-3c90-eb8b-dd8d-4f19253fabed",Form:"7f93991a-4da9-4892-79c2-35fe44e69083",Edit:"f79d78eb-4315-5fac-06e0-d58d07572482",DataEdit:"affff8b1-10b0-20a6-5bb5-a9d88334b48e",DataColumn:"100f774a-bd84-8c46-c55d-ba5981c09db5",Container:"1d95ab61-df00-aec8-eff5-0f90187891cf",Button:"af419748-7b25-1633-b0a9-d539cada8e0d",DataGrid:"ff7830e2-7add-e65e-7ddf-caba8992d6d8",UModule:"8fead303-a4e1-98bb-efb6-ee38ee021265",VisualContext:"64827c89-e73e-215f-f71a-7f90627ae61d"},controlsPath:"",uccelloPath:"",viewSet:null,init:function(config){for(var index in config)switch(index){case"controls":for(var controlNames={},i=0;i<this.controls.length;i++)controlNames[this.controls[i].className]=i;for(var i=0;i<config[index].length;i++)controlNames[config[index][i].className]?config[index][i].viewset&&(this.controls[controlNames[config[index][i].className]].viewset=config[index][i].viewset):(this.controls.push(config[index][i]),this.classGuids[config[index][i].className]=config[index][i].guid);break;default:this[index]=config[index]}}});return config}),define("connection/socket",[],function(){var Socket=Class.extend({init:function(url,options){var that=this;this.options={side:options.side?options.side:"client",open:options.open?options.open:null,close:options.close?options.close:null,router:options.router?options.router:null,connectId:options.connectId?options.connectId:null},"client"==this.options.side?(this.socket=new WebSocket(url),this.socket.onmessage=function(){that.receive.apply(that,arguments)},this.socket.onclose=function(){that.close.apply(that,arguments)},this.socket.onopen=function(){that.open.apply(that,arguments)}):(this.socket=url,this.socket.on("message",function(){that.receive.apply(that,arguments)}),this.socket.on("close",function(){that.close.apply(that,arguments)}),this.socket.on("open",function(){that.open.apply(that,arguments)})),this.msgId=0,this.messages={}},isEnabled:function(){return window.WebSocket},isConnected:function(){return 1==this.socket.readyState},send:function(obj,callback){var msgId="client"==this.options.side?++this.msgId:--this.msgId;obj.msgId||(obj.msgId=msgId),this.messages[msgId]={callback:callback,time:Date.now()},this.isConnected()&&this.socket.send(JSON.stringify(obj))},open:function(event){this.options.open&&this.options.open(event,this.options.connectId)},receive:function(event){var data=JSON.parse("client"==this.options.side?event.data:event),that=this;if(this.options.router&&this.options.router(data,this.options.connectId,this,function(result){"method"==data.type&&(console.log("result:",result),result||(result={}),result.msgId=data.msgId,that.send(result))}),data.msgId&&this.messages[data.msgId]){var msg=this.messages[data.msgId];delete this.messages[data.msgId],msg.callback&&msg.callback(data)}},close:function(event){this.options.close&&this.options.close(event,this.options.connectId)},getConnectId:function(){return this.options.connectId}});return Socket}),define("memDB/memObjLog",[],function(){var MemObjLog=Class.extend({init:function(obj){this.pvt={},this.pvt.obj=obj,this.pvt.log=[],this.pvt.versions={},this.pvt.active=!1,this.pvt.actver=-1,this.pvt.newlog=!0},truncate:function(){this.pvt.log=[]},setActive:function(active){this.pvt.active=active?!0:!1},getActive:function(){return this.pvt.active},getObj:function(){return this.pvt.obj},undo:function(version){var ver1=String(version+1);if(ver1 in this.pvt.versions){{var log=this.pvt.log;this.getObj().getDB()}this.setActive(!1);for(var i=log.length-1;i>=this.pvt.versions[version+1];i--){{var c=log[i];c.obj.getGuid()}switch(c.type){case"mp":for(var fld in c.flds)c.obj.set(fld,c.flds[fld].old);break;case"add":var par=c.obj.getParent();par.getCol(c.colName)._del(c.obj);break;case"del":}}this.setActive(!0)}},genDelta:function(){var delta={},deltaIdx={};delta.items=[];var log=this.pvt.log,db=this.getObj().getDB(),sver=db.getVersion("sent"),ver=db.getVersion();if(ver==sver)return null;for(var k=1;void 0==this.pvt.versions[sver+k]&&ver>=sver+k;)k++;if(void 0==this.pvt.versions[sver+k])return null;for(var start=this.pvt.versions[sver+k],i=start;i<log.length;i++){var c=log[i],s=c.obj.getGuid();if(s in deltaIdx)curd=delta.items[deltaIdx[s]];else{var curd={};curd.guid=c.obj.getGuid(),deltaIdx[s]=delta.items.length,delta.items.push(curd)}switch(c.type){case"mp":"fields"in curd||(curd.fields={});for(var fld in c.flds)curd.fields[fld]=c.flds[fld]["new"];break;case"add":curd.add=c.adObj,curd.parentGuid=c.guid,curd.parentColName=c.colName;break;case"newRoot":curd.newRoot=c.adObj;break;case"del":curd.parentGuid=c.guid,curd.parentColName=c.colName,curd.deleted=1}}return delta.rootGuid=this.getObj().getRoot().getGuid(),delta.dbVersion=this.getObj().getDB().getVersion(),delta},applyDelta:function(delta){this.setActive(!1);for(var db=this.getObj().getDB(),i=0;i<delta.items.length;i++){var c=delta.items[i];if("deleted"in c){var o=db.getObj(c.parentGuid);o.getCol(c.parentColName)._del(db.getObj(c.guid))}else{if("add"in c){var o=db.getObj(c.parentGuid),cb=db._cbGetNewObject(db.getObj(c.parentGuid).getRoot().getGuid());db.deserialize(c.add,{obj:o,colName:c.parentColName},cb)}if(o2=this.getObj().getDB().getObj(c.guid),o2)for(var cf in c.fields)o2.set(cf,c.fields[cf])}}this.setActive(!0)},add:function(item){var db=this.getObj().getDB(),ver=db.getCurrentVersion();ver.toString()in this.pvt.versions||(this.pvt.versions[ver]=this.pvt.log.length),this.getActive()&&(item.idx=this.getObj().getDB().getNewCounter(),this.pvt.log.push(item))}});return MemObjLog}),define("memDB/memProtoObj",["./memObjLog"],function(MemObjLog){var MemProtoObj=Class.extend({init:function(objType,parent,flds){var pvt=this.pvt={};pvt.objType=objType,pvt.fields=[],pvt.collections=[],pvt.log=null,pvt.state=0,pvt.fldLog={},pvt.colLog={},pvt.isModified=!1,parent.obj?(pvt.col=parent.obj.getCol(parent.colName),pvt.parent=parent.obj,pvt.colName=parent.colName):(pvt.col=null,pvt.db=parent.db,pvt.parent=null),void 0==this.getDB()&&console.log(parent.obj),pvt.$id=this.getDB().getNewLid(),pvt.guid=flds&&flds.$sys&&flds.$sys.guid?flds.$sys.guid:this.getDB().getController().guid(),parent.obj||(pvt.log=new MemObjLog(this),"RW"!=parent.mode||parent.nolog||pvt.db.isMaster()||pvt.log.setActive(!0),objType&&objType.getGuid()!=UCCELLO_CONFIG.classGuids.DataRoot?pvt.db._addRoot(this,{type:"res",mode:parent.mode}):pvt.db._addRoot(this,{type:"data",mode:parent.mode})),this.getDB()._addObj(this)},finit:function(){this.pvt.col&&this.pvt.col._add(this),this.pvt.state=1},addChild:function(){},getDB:function(){return this.pvt.col?this.pvt.col.getDB():this.pvt.db},getLid:function(){return this.pvt.$id},getGuid:function(){return this.pvt.guid},getObjType:function(){return this.pvt.objType},getTypeGuid:function(){return null==this.pvt.objType?this.pvt.typeGuid:this.pvt.objType.getGuid()},getParent:function(){return this.pvt.parent},getRoot:function(){for(var r=this;null!=r.getParent();)r=r.getParent();return r},getRootVersion:function(verType){var robj=this.getRoot(),rholder=this.getDB().getRoot(robj.getGuid());switch(verType){case"sent":return rholder.sver;case"valid":return rholder.vver;default:return rholder.dver}},getLog:function(){for(var p=this;!p.pvt.log;)p=p.getParent();return p.pvt.log},get:function(field){return this.pvt.fields[field]},count:function(){return this.pvt.fields.length},_addCol:function(col){this.pvt.collections.push(col)},countCol:function(){return this.pvt.collections.length},getCol:function(i){return this.pvt.collections[i]},consoleLog:function(buf){void 0===buf?buf="":buf+="  ";for(var i=0;i<this.count();i++)console.log(buf+this.getFieldName(i)+" = "+this.get(i));for(i=0;i<this.countCol();i++){console.log(buf+this.getCol(i).getName());for(var j=0;j<this.getCol(i).count();j++)this.getCol(i).get(j).consoleLog(buf)}},getColName:function(){return this.pvt.colName},isFldModified:function(fldName){return fldName in this.pvt.fldLog?!0:!1},_setModified:function(field,oldValue){this.pvt.fldLog[field]=oldValue,this.pvt.isModified=!0},getOldFldVal:function(fldName){return fldName in this.pvt.fldLog?this.pvt.fldLog[fldName]:void 0},resetModifFldLog:function(){this.pvt.fldLog={};for(var col in this.pvt.colLog)this.pvt.colLog[col].del={},this.pvt.colLog[col].add={},this.pvt.colLog[col].mod={};this.pvt.isModified=!1},logColModif:function(op,colName,obj){colName in this.pvt.colLog||(this.pvt.colLog[colName]={},this.pvt.colLog[colName].del={},this.pvt.colLog[colName].add={},this.pvt.colLog[colName].mod={}),this.pvt.colLog[colName][op][obj.getGuid()]=obj,this.pvt.isModified=!0},getLogCol:function(colName){return this.pvt.colLog[colName]},isDataModified:function(){return this.pvt.isModified}});return MemProtoObj}),define("memDB/memCol",[],function(){var MemCol=Class.extend({init:function(name,obj){this._elems=[],this._elemsByName={},this._name=name,this._obj=obj,this._db=obj.getDB(),obj._addCol(this)},_add:function(obj){this._elems.push(obj);var cname=obj.get("cname");void 0!==cname&&(this._elemsByName[cname]=this._elems.length-1);var fname=obj.get("fname");if(void 0!==fname&&(this._elemsByName[fname]=this._elems.length-1),this._obj.getLog().getActive()){var mg=obj.getParent()?obj.getParent().getGuid():"",newObj=this._obj.getDB().serialize(obj),o={adObj:newObj,obj:obj,colName:this._name,guid:mg,type:"add"};this._obj.getLog().add(o)}var p=this.getParent();p.logColModif("add",this._name,obj)},_del:function(obj){for(var i=0;i<this._elems.length;i++)if(this._elems[i]==obj){if(this._elems.splice(i,1),this._obj.getLog().getActive()){var o={obj:obj,colName:this._name,guid:obj.getParent().getGuid(),type:"del"};this._obj.getLog().add(o)}this.getDB().onDeleteObject(obj);var p=this.getParent();return void p.logColModif("del",this._name,obj)}},getName:function(){return this._name},getObjById:function(id){for(var i=0;i<this.count();i++)if(this.get(i).get("Id")==id)return this.get(i)},count:function(){return this._elems.length},get:function(i){return this._elems[i]},getIdxByName:function(name){return this._elemsByName[name]},getDB:function(){return this._db},getParent:function(){return this._obj}});return MemCol}),define("memDB/memMetaObj",["./memProtoObj","./memCol"],function(MemProtoObj,MemCol){var MemMetaObj=MemProtoObj.extend({init:function(parent,flds){var db=parent.db?parent.db:parent.obj.getDB();this._super(null,{obj:db.getMeta(),colName:"MetaObjects"},flds),this.pvt.typeGuid="4dcd61c3-3594-7456-fd86-5a3527c5cdcc",this.pvt.fields.push(flds.fields.typeName),this.pvt.fields.push(flds.fields.parentClass),this.pvt.ancestors=[],this.pvt.ancestors.push(this);for(var par=this.getDB().getObj(flds.fields.parentClass);par;)this.pvt.ancestors.push(par),par=void 0==par.get("parentClass")?null:this.getDB().getObj(par.get("parentClass"));this.pvt.rtype=flds.$sys.guid==UCCELLO_CONFIG.classGuids.DataRoot||"73596fd8-6901-2f90-12d7-d1ba12bae8f4"==flds.$sys.guid||"59583572-20fa-1f58-8d3f-5114af0f2c51"==flds.$sys.guid||"16ec0891-1144-4577-f437-f98699464948"==flds.$sys.guid||"08a0fad1-d788-3604-9a16-3544a6f97721"==flds.$sys.guid||"86c611ee-ed58-10be-66f0-dfbb60ab8907"==flds.$sys.guid||"56cc264c-5489-d367-1783-2673fde2edaf"==flds.$sys.guid?"data":"res",new MemCol("fields",this),new MemCol("cols",this),this.finit()},_bldElemTable:function(){var pvt=this.pvt;pvt.fieldsTable={},pvt.fieldsArr=[];for(var n=this.countParentClass(),k=0,i=0;n>i;i++)for(var c=this.getParentClass(n-i-1),j=0;j<c.getCol("fields").count();j++){var name=c.getCol("fields").get(j).get("fname"),typ=c.getCol("fields").get(j).get("ftype");pvt.fieldsTable[name]={obj:c,idx:j,cidx:k++,ftype:typ},pvt.fieldsArr.push(name)}},getParentClass:function(i){var i1=1;return void 0!==i&&(i1=i),this.pvt.ancestors.length-1>=i1?this.pvt.ancestors[i1]:null},countParentClass:function(){return this.pvt.ancestors.length},get:function(field){if("string"==typeof field){if("typeName"==field)return this.pvt.fields[0];if("parentClass"==field)return this.pvt.fields[1]}return"number"==typeof field?this._super(field):void 0},getFieldName:function(i){return 0==i?"typeName":1==i?"parentClass":void 0},getCol:function(col){if("string"==typeof col){if("fields"==col)return this.pvt.collections[0];if("cols"==col)return this.pvt.collections[1]}return"number"==typeof col?this._super(col):null},getRtype:function(){return this.pvt.rtype},getIdxElem:function(){}});return MemMetaObj}),define("system/event",[],function(){var Event=Class.extend({init:function(){this._eventsFireEnabled=!0,this._eventHandlers={},this._queueEvents=!1,this._blockedEventsQueue=[]},eventsInit:function(){this._eventsFireEnabled=!0,this._eventHandlers={},this._queueEvents=!1,this._blockedEventsQueue=[]},on:function(handlers){this.isArray(handlers)||(handlers=[handlers]);for(var i=0,len=handlers.length;len>i;i++){var handler=handlers[i],eventName=handler.type;if(this._eventHandlers[eventName]||(this._eventHandlers[eventName]=[]),!handler.subscriber||!handler.callback)return;this._eventHandlerExists(handler)||this._eventHandlers[eventName].push(handler)}},off:function(handlers){this.isArray(handlers)||(handlers=[handlers]);for(var i=0,len=handlers.length;len>i;i++){var handler=handlers[i],eventName=handler.type;if(!this._eventHandlers[eventName])return;for(var typeHandlers=this._eventHandlers[eventName],j=0,len2=typeHandlers.length;len2>j;j++)if(typeHandlers[j].subscriber===handler.subscriber&&typeHandlers[j].callback===handler.callback){typeHandlers.splice(j,1);break}}},_eventHandlerExists:function(handler){var eventName=handler.type;if(eventName in this._eventHandlers)for(var typeHandlers=this._eventHandlers[eventName],i=0,len=typeHandlers.length;len>i;i++){var typeHandler=typeHandlers[i];if(typeHandler.subscriber===handler.subscriber&&typeHandler.callback===handler.callback)return!0}return!1},_fire:function(eventArgs){if(eventArgs.type in this._eventHandlers)for(var handlers=this._eventHandlers[eventArgs.type],i=0,len=handlers.length;len>i;i++){var handler=handlers[i];handler.callback.call(handler.subscriber,eventArgs)}},fire:function(eventArgs){eventArgs.target||(eventArgs.target=this),eventArgs.type&&(!this._eventsFireEnabled&&this._queueEvents?this._blockedEventsQueue.push(eventArgs):this._eventsFireEnabled&&this._fire(eventArgs))},beginInit:function(queueEvents){this._eventsFireEnabled&&(this._eventsFireEnabled=!1,this._queueEvents=queueEvents,this._blockedEventsQueue=[])},endInit:function(){this._eventsFireEnabled=!0;for(var i=0,len=this._blockedEventsQueue.length;len>i;i++)this._fire(this._blockedEventsQueue[i])},resetEventQueue:function(){this._blockedEventsQueue=[]},isArray:function(ar){return ar instanceof Array||Array.isArray(ar)||ar&&ar!==Object.prototype&&Array.isArray(ar.__proto__)}});return Event}),define("memDB/memObj",["./memProtoObj","./memCol","../system/event"],function(MemProtoObj,MemCol,Event){var MemObj=MemProtoObj.extend({init:function(objType,parent,flds){this._super(objType,parent,flds),this.event=new Event;for(var ot=this.pvt.objType,i=0;i<ot.pvt.fieldsArr.length;i++){var f=ot.pvt.fieldsArr[i];this.pvt.fields[i]=void 0!=flds&&"fields"in flds&&f in flds.fields?flds.fields[f]:void 0}for(var ccol=objType.getCol("cols"),i=0;i<ccol.count();i++)new MemCol(ccol.get(i).get("cname"),this);this.finit()},getCol:function(col){if("string"==typeof col){var i=this.pvt.objType.getCol("cols").getIdxByName(col);return this.pvt.collections[i]}return"number"==typeof col?this._super(col):null},get:function(field){if("string"==typeof field){if(void 0===this.pvt.objType.pvt.fieldsTable[field])return void 0;var i=this.pvt.objType.pvt.fieldsTable[field].cidx;return this.pvt.fields[i]}return"number"==typeof field?this._super(field):void 0},set:function(field,value){var i=this.pvt.objType.pvt.fieldsTable[field].cidx,oldValue=this.pvt.fields[i];if(this.pvt.fields[i]!=value){if(this.pvt.fields[i]=value,this.getLog().getActive()){var o={flds:{},obj:this,type:"mp"};o.flds[field]={old:oldValue,"new":value},this.getLog().add(o)}this.isFldModified(field)||this._setModified(field,oldValue),this.getParent()&&this.getParent().logColModif("mod",this.getColName(),this),this.event.fire({type:"mod",target:this,field:field})}},getFieldName:function(i){return this.pvt.objType.pvt.fieldsArr[i]},getFieldType:function(i){return this.pvt.objType.pvt.fieldsTable[this.pvt.objType.pvt.fieldsArr[i]].ftype},countFields:function(){return this.pvt.objType.pvt.fieldsArr.length}});return MemObj}),define("memDB/memMetaObjFields",["./memProtoObj"],function(MemProtoObj){var MemMetaObjFields=MemProtoObj.extend({init:function(parent,flds){this._super(null,{obj:parent.obj,colName:"fields"},flds),this.pvt.typeGuid="0fa90328-4e86-eba7-b12b-4fff3a057533",this.pvt.fields.push(flds.fields.fname),this.pvt.fields.push(flds.fields.ftype),this.pvt.fields.push(flds.fields.fdefault),this.finit()},get:function(field){if("string"==typeof field){if("fname"==field)return this.pvt.fields[0];if("ftype"==field)return this.pvt.fields[1];if("fdefault"==field)return this.pvt.fields[2]}return"number"==typeof field?this._super(field):void 0},getFieldName:function(i){return 0==i?"fname":1==i?"ftype":2==i?"fdefault":void 0}});return MemMetaObjFields}),define("memDB/memMetaObjCols",["./memProtoObj"],function(MemProtoObj){var MemMetaObjCols=MemProtoObj.extend({init:function(parent,flds){this._super(null,{obj:parent.obj,colName:"cols"},flds),this.pvt.typeGuid="99628583-1667-3341-78e0-fb2af29dbe8",this.pvt.fields.push(flds.fields.cname),this.pvt.fields.push(flds.fields.ctype),this.finit()},get:function(field){if("string"==typeof field){if("cname"==field)return this.pvt.fields[0];if("ctype"==field)return this.pvt.fields[1]}return"number"==typeof field?this._super(field):void 0},getFieldName:function(i){return 0==i?"cname":1==i?"ctype":void 0}});return MemMetaObjCols}),define("system/uobject",["../memDB/memMetaObj","../memDB/memObj","../memDB/memMetaObjFields","../memDB/memMetaObjCols"],function(MemMetaObj,MemObj,MemMetaObjFields,MemMetaObjCols){var UObject=Class.extend({className:"UObject",classGuid:"3b02ef32-83b7-e470-ec5c-f6605e46e9dc",metaFields:[],metaCols:[],init:function(cm,params){if(this.pvt={},this.pvt.controlMgr=cm,this.pvt.isProcessed=!0,this._buildMetaInfo(cm.getDB()),void 0!=params){if(void 0!==params.objGuid)this.pvt.obj=cm.getDB().getObj(params.objGuid);else{if("colName"in params)col=params.colName;else var col="Children";params.ini=params.ini?params.ini:{},void 0===params.parent?(this.pvt.obj=new MemObj(cm.getDB().getObj(this.classGuid),{db:cm.getDB(),mode:"RW"},params.ini),this.pvt.parent=null):(this.pvt.obj=new MemObj(cm.getDB().getObj(this.classGuid),{obj:params.parent.getObj(),colName:col},params.ini),this.pvt.parent=params.parent)}cm.add(this)}},subsInit:function(){},dataInit:function(){},processDelta:function(){},_buildMetaInfo:function(db){if(!db.getObj(this.classGuid)){var obj=Object.getPrototypeOf(this),gobj="";"UObject"!=obj.className&&(gobj=db.getObj(Object.getPrototypeOf(obj).classGuid).getGuid());for(var c=new MemMetaObj({db:db},{fields:{typeName:this.className,parentClass:gobj},$sys:{guid:this.classGuid}}),i=0;i<this.metaFields.length;i++)new MemMetaObjFields({obj:c},{fields:this.metaFields[i]});for(i=0;i<this.metaCols.length;i++)new MemMetaObjCols({obj:c},{fields:this.metaCols[i]});db._buildMetaTables()}},getLid:function(){return this.pvt.obj.getLid()},getGuid:function(){return this.pvt.obj.getGuid()},getClassGuid:function(){return this.classGuid},getClassName:function(){return this.className},getObj:function(){return this.pvt.obj},getDB:function(){return this.pvt.obj.getDB()},getComp:function(guid){return this.pvt.controlMgr.get(guid)},getRoot:function(){return this.pvt.controlMgr.get(this.pvt.obj.getRoot().getGuid())},getModule:function(){var obj=this.getRoot();return obj.isModule()?obj:void 0},getParent:function(){return null==this.getObj().getParent()?null:this.pvt.controlMgr.getByGuid(this.getObj().getParent().getGuid())},countChild:function(colName){void 0==colName&&(colName="Children");var col=this.getObj().getCol(colName);return void 0==col?void 0:col.count()},getChild:function(i,colName){void 0==colName&&(colName="Children");var col=this.getObj().getCol(colName);return void 0==col?void 0:this.getControlMgr().get(col.get(i).getGuid())},getControlMgr:function(){return this.pvt.controlMgr},_delChild:function(colName,obj){this.getObj().getCol(colName)._del(obj)},countProps:function(){return this.pvt.obj.countFields()},getPropName:function(i){return i>=0&&i<this.pvt.obj.countFields()?this.pvt.obj.getFieldName(i):void 0},getPropType:function(i){return i>=0&&i<this.pvt.obj.countFields()?this.pvt.obj.getFieldType(i):void 0},isModule:function(){return this.pvt.parent?!1:!0},isMaster:function(){return this.getObj().getDB().isMaster()},remoteCall:function(func,aparams,cb){if(!this.getModule().isMaster()){var socket=this.getControlMgr().getSocket(),pg=this.getObj().getDB().getProxyMaster().guid,myargs={masterGuid:pg,objGuid:this.getGuid(),aparams:aparams,func:func},args={action:"remoteCall2",type:"method",args:myargs};socket.send(args,cb)}},_isProcessed:function(value){return void 0===value?this.pvt.isProcessed:(this.pvt.isProcessed=value?!0:!1,this.pvt.isProcessed)},_genericSetter:function(fldName,fldVal,kind){if(void 0!==fldVal){var val=this.getObj().get(fldName);val!=fldVal&&(this.isMaster()||"MASTER"!=kind?this.pvt.obj.set(fldName,fldVal):console.log("ERROR SET PROP"))}return this.pvt.obj.get(fldName)}});return UObject}),define("controls/aComponent",["../system/uobject"],function(UObject){var AComponent=UObject.extend({className:"AComponent",classGuid:UCCELLO_CONFIG.classGuids.AComponent,metaFields:[{fname:"Id",ftype:"int"},{fname:"Name",ftype:"string"}],metaCols:[],init:function(cm,params){this._super(cm,params),this.pvt.isRendered=!1,void 0!=params&&this.pvt.obj.event.on({type:"mod",subscriber:this,callback:this._onDirtyRender})},_onDirtyRender:function(){this.pvt.isRendered=!1},_isRendered:function(value){return void 0===value?this.pvt.isRendered:(this.pvt.isRendered=value?!0:!1,this.pvt.isRendered)},initRender:function(){},id:function(value){return this._genericSetter("Id",value)},name:function(value){return this._genericSetter("Name",value)}});return AComponent}),define("connection/clientConnection",["./socket","../controls/aComponent"],function(Socket,AComponent){var ClientConnection=AComponent.extend({className:"ClientConnection",classGuid:UCCELLO_CONFIG.classGuids.ClientConnection,metaFields:[],metaCols:[{cname:"VisualContext",ctype:"control"}],init:function(cm,params){cm?this._super(cm,params):(this.socket=null,this.session=null,this.connected=!1,this.authenticated=!1,this.newTabCallback=params.newTabCallback)},connect:function(url,session,callback){var that=this;this.session=session,that.socket=new Socket(url,{open:function(){that.connected=!0,that.socket.send({action:"connect",type:"method",session:JSON.stringify(session),agent:navigator.userAgent},callback)},close:function(){that.connected=!1},router:function(data){var result={};switch(data.action){case"error":console.log(data.error);break;case"sendDelta":console.timeEnd("applyDeltas"),that.getObj().getDB().getController().applyDeltas(data.dbGuid,data.srcDbGuid,data.delta);break;case"newTab":that.newTabCallback&&that.newTabCallback(data)}return result}})},authenticate:function(params,callback){if(!this.connected)return!1;var that=this;this.socket.send({action:"authenticate",type:"method",name:params.user,pass:params.pass,sid:this.session.guid,session:params.session},function(result){that.authenticated=result.user?result.user:!1,callback(result)})},deauthenticate:function(callback){this.authenticated=!1,this.socket.send({action:"deauthenticate",type:"method",sid:this.session.guid},callback)},disconnect:function(callback){this.socket.send({action:"disconnect",type:"method",sid:this.session.guid},callback)},getUser:function(callback){this.socket.send({action:"getUser",type:"method",sid:this.session.guid},function(result){callback(result.item)})},getSession:function(callback){this.socket.send({action:"getSession",type:"method",sid:this.session.guid},function(result){callback(result.item)})},getConnect:function(callback){this.socket.send({action:"getConnect",type:"method",sid:this.session.guid},function(result){callback(result.item)})},getUserInfo:function(){},newTab:function(contextGuid,dbGuid,resGuids,sessionGuid,callback){this.socket.send({action:"newTab",type:"method",sid:this.session.guid,contextGuid:contextGuid,dbGuid:dbGuid,resGuids:resGuids,sessionGuid:sessionGuid},function(result){callback&&callback(result)
})}});return ClientConnection}),define("connection/connectinfo",["../controls/aComponent"],function(AComponent){var ConnectInfo=AComponent.extend({className:"ConnectInfo",classGuid:UCCELLO_CONFIG.classGuids.ConnectInfo,metaFields:[{fname:"Context",ftype:"string"}],metaCols:[],init:function(cm,params){this._super(cm,params)},context:function(value){return this._genericSetter("Context",value)}});return ConnectInfo}),define("connection/connect",["./connectinfo","../system/event"],function(ConnectInfo,event){var Connect=ConnectInfo.extend({className:"Connect",classGuid:UCCELLO_CONFIG.classGuids.Connect,metaFields:[],init:function(cm,params){this._super(cm,params),void 0!=params&&(this.event=new event(this),this.ws=params.ws,this.params={connectTime:params.connectTime||Date.now(),userAgent:params.userAgent||"",numRequest:params.numRequest||0,stateReady:params.stateReady||0,lastPingTime:params.numRequest||null,pingCounter:params.pingCounter||0})},getConnection:function(){return this.ws},send:function(data){return this.ws.send(data)},getParams:function(){return this.params},getId:function(){return this.id()},getRequest:function(){return this.params.numRequest},addRequest:function(){return++this.params.numRequest},setLastPing:function(date){return this.params.lastPingTime=date||Date.now(),this.params.pingCounter++,this.params.lastPingTime},setStateReady:function(stateReady){return this.params.stateReady=stateReady,this.params.stateReady},closeConnect:function(){this.params.stateReady=0,this.event.fire({type:"socket.close",target:this,connId:this.getId()})},setSession:function(session){this.session=session},getSession:function(){return this.session},isConnected:function(){return 1==this.params.stateReady}});return Connect}),define("connection/connectInfo",["../controls/aComponent"],function(AComponent){var ConnectInfo=AComponent.extend({className:"ConnectInfo",classGuid:UCCELLO_CONFIG.classGuids.ConnectInfo,metaFields:[{fname:"Context",ftype:"string"}],metaCols:[],init:function(cm,params){this._super(cm,params)},context:function(value){return this._genericSetter("Context",value)}});return ConnectInfo}),define("connection/sessioninfo",["../controls/aComponent"],function(AComponent){var SessionInfo=AComponent.extend({className:"SessionInfo",classGuid:UCCELLO_CONFIG.classGuids.SessionInfo,metaFields:[{fname:"CreationTime",ftype:"timestamp"},{fname:"LastOpTime",ftype:"timestamp"},{fname:"DeviceName",ftype:"string"},{fname:"DeviceType",ftype:"string"},{fname:"DeviceColor",ftype:"string"},{fname:"CountConnect",ftype:"int"},{fname:"SessionGuid",ftype:"string"}],metaCols:[{cname:"Connects",ctype:"control"}],init:function(cm,params){this._super(cm,params)},creationTime:function(value){return this._genericSetter("CreationTime",value)},lastOpTime:function(value){return this._genericSetter("LastOpTime",value)},deviceName:function(value){return this._genericSetter("DeviceName",value)},deviceType:function(value){return this._genericSetter("DeviceType",value)},deviceColor:function(value){return this._genericSetter("DeviceColor",value)},sessionGuid:function(value){return this._genericSetter("SessionGuid",value)}});return SessionInfo}),define("connection/session",["./sessioninfo","../system/event"],function(SessionInfo,Event){var Session=SessionInfo.extend({className:"Session",classGuid:UCCELLO_CONFIG.classGuids.Session,metaFields:[],init:function(cm,params){this._super(cm,params),void 0!=params&&(this.pvt.event=new Event(this),this.connects=[],this.creationTime(Date.now()),this.lastOpTime(Date.now()))},getId:function(){return this.id()},addConnect:function(conn){var that=this;return conn.event.on({type:"socket.close",subscriber:this,callback:function(args){that.getDB().getController().onDisconnect(args.connId),that.removeConn(args.connId),that.getObj().getCol("Connects")._del(conn.getObj());var db=that.getObj().getDB();db.getController().genDeltas(db.getGuid())}}),conn.setSession(this),this.connects[conn.getId()]=conn,this.countConnect(!0),!0},getConnects:function(){return this.connects},getConnect:function(id){return this.connects[id]?this.connects[id]:null},removeConn:function(id){this.lastOpTime=Date.now(),this.connects[id]&&delete this.connects[id],this.countConnect(!0)},countConnect:function(value){return this._genericSetter("CountConnect",value?Object.keys(this.connects).length:void 0)},findConnect:function(id){return this.connects[id]?this.connects[id]:null},setData:function(data){this.data=data},getData:function(){return this.data},getUser:function(){return this.getParent()}});return Session}),define("connection/sessionInfo",["../controls/aComponent"],function(AComponent){var SessionInfo=AComponent.extend({className:"SessionInfo",classGuid:UCCELLO_CONFIG.classGuids.SessionInfo,metaFields:[{fname:"CreationTime",ftype:"timestamp"},{fname:"LastOpTime",ftype:"timestamp"},{fname:"DeviceName",ftype:"string"},{fname:"DeviceType",ftype:"string"},{fname:"DeviceColor",ftype:"string"},{fname:"CountConnect",ftype:"int"},{fname:"SessionGuid",ftype:"string"}],metaCols:[{cname:"Connects",ctype:"control"}],init:function(cm,params){this._super(cm,params)},creationTime:function(value){return this._genericSetter("CreationTime",value)},lastOpTime:function(value){return this._genericSetter("LastOpTime",value)},deviceName:function(value){return this._genericSetter("DeviceName",value)},deviceType:function(value){return this._genericSetter("DeviceType",value)},deviceColor:function(value){return this._genericSetter("DeviceColor",value)},sessionGuid:function(value){return this._genericSetter("SessionGuid",value)}});return SessionInfo}),define("connection/userinfo",["../controls/aComponent"],function(AComponent){var UserInfo=AComponent.extend({className:"UserInfo",classGuid:UCCELLO_CONFIG.classGuids.UserInfo,metaFields:[{fname:"Authenticated",ftype:"boolean"},{fname:"LoginTime",ftype:"time"}],metaCols:[{cname:"Sessions",ctype:"control"},{cname:"VisualContext",ctype:"control"}],init:function(cm,params){this._super(cm,params)},loginTime:function(value){return this._genericSetter("LoginTime",value)},authenticated:function(value){return this._genericSetter("LoginTime",value)}});return UserInfo}),define("connection/user",["./userinfo"],function(UserInfo){var User=UserInfo.extend({className:"User",classGuid:UCCELLO_CONFIG.classGuids.User,metaFields:[],init:function(cm,params){this._super(cm,params),void 0!=params&&(this.pvt.data={},this.pvt.sessions={})},addSession:function(session){this.pvt.sessions[session.getId()]={item:session,date:(new Date).toISOString().replace(/T/," ").replace(/\..+/,"")}},getSession:function(id){return this.pvt.sessions[id]?this.pvt.sessions[id].item:null},getSessions:function(){return this.pvt.sessions},countSession:function(){return Object.keys(this.pvt.sessions).length},getData:function(){return this.pvt.data},removeSession:function(id){this.pvt.sessions[id]&&delete this.pvt.sessions[id]}});return User}),define("connection/user2",["./userinfo"],function(UserInfo){var User2=UserInfo.extend({className:"User2",classGuid:UCCELLO_CONFIG.classGuids.User2,metaFields:[],init:function(cm,params){this._super(cm,params)}});return User2}),define("connection/userInfo",["../controls/aComponent"],function(AComponent){var UserInfo=AComponent.extend({className:"UserInfo",classGuid:UCCELLO_CONFIG.classGuids.UserInfo,metaFields:[{fname:"Authenticated",ftype:"boolean"},{fname:"LoginTime",ftype:"time"}],metaCols:[{cname:"Sessions",ctype:"control"},{cname:"VisualContext",ctype:"control"}],init:function(cm,params){this._super(cm,params)},loginTime:function(value){return this._genericSetter("LoginTime",value)},authenticated:function(value){return this._genericSetter("LoginTime",value)}});return UserInfo}),define("controls/aControl",["./aComponent"],function(AComponent){var AControl=AComponent.extend({className:"AControl",classGuid:UCCELLO_CONFIG.classGuids.AControl,metaFields:[{fname:"Top",ftype:"int"},{fname:"Left",ftype:"int"},{fname:"Width",ftype:"int"},{fname:"Height",ftype:"int"}],init:function(cm,params){this._super(cm,params)},irender:function(viewset,options){viewset.render.apply(this,[options])},top:function(value){return this._genericSetter("Top",value)},left:function(value){return this._genericSetter("Left",value)},width:function(value){return this._genericSetter("Width",value)},height:function(value){return this._genericSetter("Height",value)}});return AControl}),define("system/uobjectMgr",[],function(){var UObjectMgr=Class.extend({init:function(){}});return UObjectMgr}),define("controls/viewset",[],function(){var ViewSet=Class.extend({init:function(cm,ini){this.cm=cm,this.ini=ini,this._enable=!0},enable:function(value){return void 0!==value&&(this._enable=value),this._enable},render:function(component,options){if("_isRendered"in component&&!component._isRendered()){var viewsets=this.cm.getContext().getComponent(component.className).viewsets;viewsets&&viewsets[this.ini.name]&&component.irender(viewsets[this.ini.name],options)}var col=component.pvt.obj.getCol("Children");if(void 0!=col)for(var i=0;i<col.count();i++){var co=this.cm.get(col.get(i).getGuid());this.render(co,options)}}});return ViewSet}),define("controls/controlMgr",["../system/uobjectMgr","./viewset"],function(UObjectMgr,ViewSet){var ControlMgr=UObjectMgr.extend({init:function(db,rootGuid,vc,socket){this._super(db,rootGuid,vc),this.pvt={},this.pvt.guid=db.getController().guid(),this.pvt.compByLid={},this.pvt.compByGuid={},this.pvt.compByName={},this.pvt.subsInitFlag=!1,this.pvt.dataInitFlag=!1,this.pvt.db=db,this.pvt.rootGuids={},this.pvt.vc=vc,socket?this.pvt.socket=socket:vc&&(this.pvt.socket=vc.getSocket()),this.pvt.viewSets=[this.createViewSet(UCCELLO_CONFIG.viewSet)],this.pvt.asd=!0,db.event.on({type:"newRoot",subscriber:this,callback:this.onNewRoot})},subsInit:function(){for(var g in this.pvt.compByGuid)this.pvt.compByGuid[g].subsInit();this.pvt.subsInitFlag=!0},dataInit:function(){for(var g in this.pvt.compByGuid)this.pvt.compByGuid[g].dataInit();this.pvt.dataInitFlag=!0},add:function(component){this.pvt.compByLid[component.getLid()]=component,this.pvt.compByGuid[component.getGuid()]=component,component.name()&&(this.pvt.compByName[component.name()]=component),component.getParent()||(this.pvt.rootGuids[component.getGuid()]=component)},del:function(guid){var c=this.get(guid);delete this.pvt.compByLid[c.getLid()],delete this.pvt.compByGuid[c.getGuid()],c.getParent()?c.getParent()._delChild(c.getObj().getColName(),c.getObj()):delete this.pvt.rootGuids[c.getGuid()]},move:function(guid,parentGuid){console.log("Ð·Ð°Ð³Ð»ÑÑÐºÐ° Ð¿ÐµÑÐµÐ¼ÐµÑÐµÐ½Ð¸Ñ ÐºÐ¾Ð½ÑÑÐ¾Ð»Ð°: "+guid+" Ð² "+parentGuid)},_getCompGuidList:function(){return this.pvt.compByGuid},getDB:function(){return this.pvt.db},getContext:function(){return this.pvt.vc},getSocket:function(){return this.pvt.socket},getRootGuids:function(){var guids=[];for(var g in this.pvt.rootGuids)guids.push(g);return guids},getGuid:function(){return this.pvt.guid},getByGuid:function(guid){return this.pvt.compByGuid[guid]},get:function(guid){return this.pvt.compByGuid[guid]},getByName:function(name){return this.pvt.compByName[name]},processDelta:function(){for(var g in this.pvt.compByGuid){var c=this.pvt.compByGuid[g];c._isProcessed()||c.processDelta()}for(var g in this.pvt.compByGuid)this.pvt.compByGuid[g]._isProcessed(!1)},render:function(component,options,pd){this.pvt.subsInitFlag||this.subsInit(),this.pvt.dataInitFlag||this.dataInit(),pd&&this.processDelta();var c=void 0===component?this.getRoot():component;for(var i in this.pvt.viewSets)this.pvt.viewSets[i].enable()&&this.pvt.viewSets[i].render(c,options);this.setToRendered(!0)},setToRendered:function(val){for(var g in this.pvt.compByGuid)"_isRendered"in this.pvt.compByGuid[g]&&this.pvt.compByGuid[g]._isRendered(val)},initRender:function(){this.setToRendered(!1);for(var g in this.pvt.compByGuid)"initRender"in this.pvt.compByGuid[g]&&this.pvt.compByGuid[g].initRender()},onDeleteComponent:function(result){delete this.pvt.compByGuid[result.target.getGuid()]},onNewRoot:function(result){this.pvt.rootGuids[result.target.getGuid()]&&this.getDB().getRoot(result.target.getGuid()).event.on({type:"delObj",subscriber:this,callback:this.onDeleteComponent})},createViewSet:function(ini){return new ViewSet(this,ini)},userEventHandler:function(context,f,args){var nargs=[],db=this.getDB(),vc=this.getContext();args&&(nargs=[args]),vc&&vc.tranStart(),f&&f.apply(context,nargs),this.autoSendDeltas()&&db.getController().genDeltas(db.getGuid()),vc&&vc.renderAll(),vc&&vc.tranCommit()},autoSendDeltas:function(value){return void 0!==value&&(this.pvt.asd=value),this.pvt.asd}});return ControlMgr}),define("connection/vc",["../controls/aComponent","../controls/aControl","../controls/controlMgr","../system/uobject"],function(AComponent,AControl,ControlMgr,UObject){var VisualContext=AComponent.extend({className:"VisualContext",classGuid:UCCELLO_CONFIG.classGuids.VisualContext,metaFields:[{fname:"DataBase",ftype:"string"},{fname:"Kind",ftype:"string"},{fname:"ContextGuid",ftype:"string"}],metaCols:[],init:function(cm,params,cb){this._super(cm,params,cb),this.pvt.isOn=!1,this.pvt.isVisible=!1},on:function(cm,params,cb,renderRoot){function cb2(res){that.pvt.isOn=!0,that.pvt.renderRoot&&(that.pvt.isVisible=!0),cb(res)}if(this.isOn())return this.pvt.cm.initRender(),void cb(this.pvt.db.getRootGuids("res"));if(this.pvt.db=null,this.pvt.tranQueue=null,this.pvt.inTran=!1,void 0!=params){this.pvt.typeGuids=params.typeGuids;var controller=cm.getDB().getController();this.pvt.proxyServer=params.proxyServer,this.pvt.components=params.components,this.pvt.renderRoot=renderRoot,this.pvt.formParams={},this.pvt.memParams=[],this.pvt.socket=params.socket;var that=this,createCompCallback=null;if(createCompCallback=cb?function(obj){that.createComponent.apply(that,[obj,that.pvt.cm])}:function(obj){obj.getTypeGuid()==UCCELLO_CONFIG.classGuids.FormParam&&(obj.event.on({type:"mod",subscriber:that,callback:that._onModifParam}),that.pvt.formParams[obj.get("Name")]||(that.pvt.formParams[obj.get("Name")]=[]),that.pvt.formParams[obj.get("Name")].push(obj)),controller.event.on({type:"end2ApplyDeltas",subscriber:that,callback:that._setFormParams})},this.getModule().isMaster()){var params2={name:"VisualContextDB",kind:"master",cbfinal:cb};createCompCallback&&(params2.compcb=createCompCallback),this.pvt.db=this.createDb(controller,params2),this.pvt.cm=new ControlMgr(this.getDB(),null,this,this.pvt.socket),this.loadNewRoots(params.formGuids,{rtype:"res",compcb:params2.compcb},params2.cbfinal),this.dataBase(this.pvt.db.getGuid()),this.contextGuid(this.getGuid()),this.pvt.isOn=!0,this.pvt.renderRoot&&(this.pvt.isVisible=!0)}else guid=this.dataBase(),this.pvt.db=controller.newDataBase({name:"Slave"+guid,proxyMaster:{connect:params.socket,guid:guid}},function(){that.pvt.cm=new ControlMgr(that.getDB(),null,that,that.pvt.socket);var forms=params.formGuids;null==forms?forms="all":""==forms&&(forms=[]),that.getDB().subscribeRoots(forms,cb2,createCompCallback)});this.pvt.db.setDefaultCompCallback(createCompCallback)}},off:function(cb){function cb2(){that.pvt.isOn=!1,that.pvt.isVisible=!1,void 0!==cb&&"function"==typeof cb&&cb()}var that=this;this._dispose(cb2)},_dispose:function(cb){if(this.getModule().isMaster())cb();else{var controller=this.getControlMgr().getDB().getController();controller.delDataBase(this.getContentDB().getGuid(),cb)}},isOn:function(){return this.pvt.isOn},isVisible:function(){return this.pvt.isVisible},setVisible:function(renderRoot){return this.isOn()?(this.pvt.renderRoot=renderRoot,this.pvt.isVisible=void 0===renderRoot?!0:!1,!0):!1},_onModifParam:function(ev){this.pvt.memParams.push(ev.target)},_setFormParams:function(){for(var i=0;i<this.pvt.memParams.length;i++)for(var obj=this.pvt.memParams[i],pn=obj.get("Name"),j=0;j<this.pvt.formParams[pn].length;j++){var obj2=this.pvt.formParams[pn][j];"in"==obj2.get("Kind")&&obj2.set("Value",obj.get("Value"))}this.pvt.memParams=[],this.getDB().getController().genDeltas(this.getDB().getGuid())},createDb:function(dbc,options){var db=dbc.newDataBase(options),cm=new ControlMgr(db,null);new UObject(cm),new AComponent(cm),new AControl(cm);var ctrls=UCCELLO_CONFIG.controls;for(var i in ctrls){var path=ctrls[i].isUccello?UCCELLO_CONFIG.uccelloPath:UCCELLO_CONFIG.controlsPath,comp=require(path+ctrls[i].component);new comp(cm)}return db},tranStart:function(){this.pvt.inTran||(this.pvt.inTran=!0,this.pvt.tranQueue=[])},tranCommit:function(){if(this.pvt.inTran){for(var i=0;i<this.pvt.tranQueue.length;i++){var mc=this.pvt.tranQueue[i];mc.method.apply(mc.context,mc.args)}this.pvt.tranQueue=null,this.pvt.inTran=!1}},inTran:function(){return this.pvt.inTran},execMethod:function(context,method,args){this.inTran()?this.pvt.tranQueue.push({context:context,method:method,args:args}):method.apply(context,args)},loadNewRoots:function(rootGuids,params,cb){function icb(r){that.getDB().addRoots(r.datas,params.compcb,params.subDbGuid);cb&&cb({guids:rootGuids})}var that=this;if(this.getModule().isMaster()){if("res"==params.rtype)return this.pvt.proxyServer.loadResources(rootGuids,icb),"XXX";if("data"==params.rtype)return this.pvt.proxyServer.queryDatas(rootGuids,params.expr,icb),"XXX"}else this.remoteCall("loadNewRoots",[rootGuids,params],cb)},createComponent:function(obj,cm){var g=obj.getTypeGuid(),className=cm.getDB().getObj(g).get("typeName"),params={objGuid:obj.getGuid()};"38aec981-30ae-ec1d-8f8f-5004958b4cfa"==g&&(params.dbSelector=[{guid:this.getDB().getGuid(),name:"ÐÐ¾Ð»ÑÐ·Ð¾Ð²Ð°ÑÐµÐ»ÑÑÐºÐ°Ñ ÐÐ"},{guid:uccelloClt.getSysDB().getGuid(),name:"Ð¡Ð¸ÑÑÐµÐ¼Ð½Ð°Ñ ÐÐ"}]),new(this.getComponent(className).module)(cm,params)},getComponent:function(className){return this.pvt.components[className]},renderAll:function(pd){for(var ga=this.pvt.cm.getRootGuids(),i=0;i<ga.length;i++)this.pvt.cm.render(this.pvt.cm.get(ga[i]),this.pvt.renderRoot(ga[i]),pd);this.getDB().resetModifLog()},renderForms:function(roots,pd){for(var i=0;i<roots.length;i++){var root=this.pvt.cm.get(roots[i]);void 0!==root&&this.pvt.cm.render(root,this.pvt.renderRoot(roots[i]),pd)}this.getDB().resetModifLog()},getDB:function(){return this.pvt.db},getContentDB:function(){return this.pvt.db},getContextCM:function(){return this.pvt.cm},getSocket:function(){return this.pvt.socket},dataBase:function(value){return this._genericSetter("DataBase",value)},kind:function(value){return this._genericSetter("Kind",value)},contextGuid:function(value){return this._genericSetter("ContextGuid",value,"MASTER")}});return VisualContext}),define("controls/aDataControl",["./aControl"],function(AControl){var ADataControl=AControl.extend({className:"ADataControl",classGuid:UCCELLO_CONFIG.classGuids.ADataControl,metaFields:[{fname:"Dataset",ftype:"string"}],init:function(cm,params){this._super(cm,params)},subsInit:function(){this._subsDataSet()},processDelta:function(){var dsg=this.dataset();if(dsg){var dsc=this.getComp(dsg),dso=dsc.getObj();if(dsc._isProcessed()||dsc.processDelta(),dsc.root()&&this.getControlMgr().getDB().getObj(dsc.root()))var dsmod=this.getDB().getObj(dsc.root()).isDataModified();else dsmod=!1;(dso.isFldModified("Root")||dso.isFldModified("Cursor")||dsmod)&&this._isRendered(!1)}this._isProcessed(!0)},_subsDataSet:function(){var dsg=this.dataset();if(dsg){var ds=this.getControlMgr().get(dsg);ds.event.on({type:"refreshData",subscriber:this,callback:function(){this._isRendered(!1)}}),ds.event.on({type:"moveCursor",subscriber:this,callback:function(){this._isRendered(!1)}}),ds.event.on({type:"modFld",subscriber:this,callback:function(){this._isRendered(!1)}})}},dataset:function(value){return this._genericSetter("Dataset",value)}});return ADataControl}),define("controls/aDataFieldControl",["./aDataControl"],function(ADataControl){var ADataFieldControl=ADataControl.extend({className:"ADataFieldControl",classGuid:UCCELLO_CONFIG.classGuids.ADataFieldControl,metaFields:[{fname:"DataField",ftype:"string"}],init:function(cm,params){this._super(cm,params)},dataField:function(value){return this._genericSetter("DataField",value)}});return ADataFieldControl}),define("controls/aDataModel",["./aComponent"],function(AComponent){var ADataModel=AComponent.extend({className:"ADataModel",classGuid:UCCELLO_CONFIG.classGuids.ADataModel,metaCols:[{cname:"Datasets",ctype:"data"}],metaFields:[],init:function(cm,params){this._super(cm,params)}});return ADataModel}),define("controls/button",[UCCELLO_CONFIG.uccelloPath+"controls/aControl"],function(AControl){var Button=AControl.extend({className:"Button",classGuid:UCCELLO_CONFIG.classGuids.Button,metaFields:[{fname:"Caption",ftype:"string"}],init:function(cm,params){this._super(cm,params),this.params=params},caption:function(value){return this._genericSetter("Caption",value)}});return Button}),define("controls/container",[UCCELLO_CONFIG.uccelloPath+"controls/aControl"],function(AControl){var Container=AControl.extend({className:"Container",classGuid:UCCELLO_CONFIG.classGuids.Container,metaCols:[{cname:"Children",ctype:"control"}],metaFields:[],init:function(cm,params){this._super(cm,params),this.params=params}});return Container}),define("controls/dataColumn",[UCCELLO_CONFIG.uccelloPath+"controls/aComponent"],function(AComponent){var DataColumn=AComponent.extend({className:"DataColumn",classGuid:UCCELLO_CONFIG.classGuids.DataColumn,metaCols:[],metaFields:[{fname:"Label",ftype:"string"},{fname:"Width",ftype:"int"},{fname:"Field",ftype:"string"}],init:function(cm,params){this._super(cm,params),this.params=params},label:function(value){return this._genericSetter("Label",value)},width:function(value){return this._genericSetter("Width",value)},field:function(value){return this._genericSetter("Field",value)}});return DataColumn}),define("controls/dataEdit",[UCCELLO_CONFIG.uccelloPath+"controls/aDataFieldControl"],function(ADataFieldControl){var DataEdit=ADataFieldControl.extend({className:"DataEdit",classGuid:UCCELLO_CONFIG.classGuids.DataEdit,metaFields:[],init:function(cm,params){this._super(cm,params),this.params=params}});return DataEdit}),define("controls/dataField",[UCCELLO_CONFIG.uccelloPath+"controls/aComponent"],function(AComponent){var DataField=AComponent.extend({className:"DataField",classGuid:UCCELLO_CONFIG.classGuids.DataField,metaCols:[],metaFields:[],init:function(cm,params){this._super(cm,params),this.params=params}});return DataField}),define("controls/dataGrid",[UCCELLO_CONFIG.uccelloPath+"controls/aDataControl"],function(ADataControl){var DataGrid=ADataControl.extend({className:"DataGrid",classGuid:UCCELLO_CONFIG.classGuids.DataGrid,metaFields:[],metaCols:[{cname:"Columns",ctype:"DataColumn"}],init:function(cm,params){this._super(cm,params),this.params=params,this.initRender()},irender:function(viewset,options){var columns=this.getObj().getCol("Columns");if(columns){for(var modified=!1,i=0,len=columns.count();len>i;i++){var column=columns.get(i);column.isFldModified("width")&&(modified=!0,viewset.renderWidth.apply(this,[i,column.get("Width")]))}if(modified)return}return this.isOnlyCursor()?void viewset.renderCursor.apply(this,[this.getControlMgr().getByGuid(this.dataset()).cursor()]):(viewset.render.apply(this,[options]),void(this.dataset()&&(this.pvt.renderDataVer=this.getControlMgr().getByGuid(this.dataset()).getDataVer())))},isOnlyCursor:function(){if(this.dataset()){var dataset=this.getControlMgr().getByGuid(this.dataset());return this.pvt.renderDataVer!=dataset.getDataVer()||dataset.isDataModified()?!1:!0}return!1},initRender:function(){this.pvt.renderDataVer=void 0}});return DataGrid}),define("controls/dataset",["./aComponent","../system/event"],function(AComponent,Event){var Dataset=AComponent.extend({className:"Dataset",classGuid:UCCELLO_CONFIG.classGuids.Dataset,metaFields:[{fname:"Root",ftype:"string"},{fname:"Cursor",ftype:"string"},{fname:"Active",ftype:"boolean"},{fname:"Master",ftype:"string"},{fname:"OnMoveCursor",ftype:"event"}],metaCols:[{cname:"Fields",ctype:"DataField"}],init:function(cm,params){this._super(cm,params),this.pvt.params=params,this.pvt.dataObj=null,this.pvt.dataVer=0,this.event=new Event,this.getObj()&&this.getObj().get("OnMoveCursor")&&(this.onMoveCursor=new Function("newVal",this.getObj().get("OnMoveCursor")))},subsInit:function(){var master=this.master();master&&this.active()&&(this.getControlMgr().get(master).event.on({type:"refreshData",subscriber:this,callback:function(){this._dataInit(!0)}}),this.getControlMgr().get(master).event.on({type:"moveCursor",subscriber:this,callback:function(){this._dataInit(!1)}}))},dataInit:function(){this.active()&&this._dataInit(!0)},processDelta:function(){var obj=this.getObj();obj.isFldModified("Cursor")&&(console.log("processDelta "+this.id()),this._setDataObj(this.cursor()));var r=this.getDB().getObj(this.root());r&&r.isDataModified()&&this.pvt.dataVer++,this._isProcessed(!0)},_dataInit:function(onlyMaster){function icb(){function refrcb(){this.pvt.dataVer++,this._initCursor(),this.event.fire({type:"refreshData",target:this})}that.getControlMgr().userEventHandler(that,refrcb)}if(this.active()){var rg=this.root(),master=this.master();if(rg){var dataRoot=this.getControlMgr().getDB().getRoot(rg);if(dataRoot&&onlyMaster)this._initCursor();else{if(onlyMaster&&master)return;var that=this,params={rtype:"data"};master&&(params.expr=this.getControlMgr().get(master).getField("Id")),this.getControlMgr().getContext().loadNewRoots([rg],params,icb)}}}},_initCursor:function(){var rg=this.root();if(rg){var dataRoot=this.getDB().getObj(rg);if(dataRoot){var col=dataRoot.getCol("DataElements");dataRoot.getCol("DataElements").getObjById(this.cursor())||(col.count()>0?this.cursor(col.get(0).get("Id")):this._setDataObj(this.cursor()))}}},getField:function(name){return this.pvt.dataObj?this.pvt.dataObj.get(name):void 0},setField:function(name,value){return this.pvt.dataObj?(r=this.pvt.dataObj.set(name,value),this.event.fire({type:"modFld",target:this}),r):void 0},getDataVer:function(){return this.pvt.dataVer},isDataModified:function(){var r=this.root();if(r){var rootObj=this.getDB().getObj(r);return rootObj?rootObj.isDataModified():!0}return!0},initRender:function(){this.pvt.dataVer=0},root:function(value){var oldVal=this._genericSetter("Root"),newVal=this._genericSetter("Root",value);return newVal!=oldVal&&(console.log("refreshData in root() "+this.id()),this.event.fire({type:"refreshData",target:this})),newVal},cursor:function(value){var oldVal=this._genericSetter("Cursor"),newVal=this._genericSetter("Cursor",value);return newVal!=oldVal&&(this._setDataObj(value),"onMoveCursor"in this&&this.onMoveCursor(newVal),this.event.fire({type:"moveCursor",target:this})),newVal},_setDataObj:function(value){this.pvt.dataObj=this.getDB().getObj(this.root()).getCol("DataElements").getObjById(value)},active:function(value){return this._genericSetter("Active",value)},master:function(value){return this._genericSetter("Master",value)}});return Dataset}),define("controls/edit",[UCCELLO_CONFIG.uccelloPath+"controls/aControl"],function(AControl){var Edit=AControl.extend({className:"Edit",classGuid:UCCELLO_CONFIG.classGuids.Edit,metaFields:[{fname:"Value",ftype:"string"}],init:function(cm,params){this._super(cm,params),this.params=params},value:function(value){return this._genericSetter("Value",value)}});return Edit}),define("controls/form",[UCCELLO_CONFIG.uccelloPath+"controls/container"],function(Container){var Form=Container.extend({className:"Form",classGuid:UCCELLO_CONFIG.classGuids.Form,metaFields:[],metaCols:[{cname:"Params",ctype:"control"},{cname:"Children",ctype:"control"},{cname:"SubForms",ctype:"control"}],init:function(cm,params){this._super(cm,params)}});return Form}),define("controls/formParam",["./aComponent"],function(AComponent){var FormParam=AComponent.extend({className:"FormParam",classGuid:UCCELLO_CONFIG.classGuids.FormParam,metaFields:[{fname:"Type",ftype:"string"},{fname:"Kind",ftype:"string"},{fname:"Value",ftype:"string"},{fname:"OnModify",ftype:"event"}],init:function(cm,params){this._super(cm,params),this.getObj()&&this.getObj().get("OnModify")&&(this.onModify=new Function("newVal",this.getObj().get("OnModify")))},processDelta:function(){var obj=this.getObj();obj.isFldModified("Value")&&"onModify"in this&&this.onModify(this.value())},type:function(value){return this._genericSetter("Type",value)},kind:function(value){return this._genericSetter("Kind",value)},value:function(value){return this._genericSetter("Value",value)}});return FormParam}),define("controls/label",[UCCELLO_CONFIG.uccelloPath+"controls/aControl"],function(AControl){var Label=AControl.extend({className:"Label",classGuid:UCCELLO_CONFIG.classGuids.Label,metaFields:[{fname:"Label",ftype:"string"}],init:function(cm,params){this._super(cm,params),this.params=params},label:function(value){return this._genericSetter("Label",value)}});return Label}),define("controls/subForm",["./aComponent"],function(AComponent){var SubForm=AComponent.extend({className:"SubForm",classGuid:UCCELLO_CONFIG.classGuids.SubForm,metaFields:[{fname:"FormGuid",ftype:"string"}],init:function(cm,params){this._super(cm,params)},formGuid:function(value){return this._genericSetter("FormGuid",value)}});return SubForm}),define("dataman/dataRoot",["../controls/aComponent"],function(AComponent){var DataRoot=AComponent.extend({className:"DataRoot",classGuid:UCCELLO_CONFIG.classGuids.DataRoot,metaCols:[{cname:"DataElements",ctype:"data"}],metaFields:[],init:function(cm,params){this._super(cm,params)}});return DataRoot}),define("memDB/memMetaRoot",["./memProtoObj","./memCol"],function(MemProtoObj,MemCol){var MemMetaRoot=MemProtoObj.extend({init:function(parent,flds){flds.$sys={guid:"fc13e2b8-3600-b537-f9e5-654b7418c156"},this._super(null,{db:parent.db},flds),this.pvt.typeGuid="fc13e2b8-3600-b537-f9e5-654b7418c156",new MemCol("MetaObjects",this),this.finit()},getFieldName:function(){return void 0},getCol:function(col){return"string"==typeof col&&"MetaObjects"==col?this.pvt.collections[0]:"number"==typeof col?this._super(col):null}});return MemMetaRoot}),define("memDB/memDataBase",["../system/event","./memCol","./memObj","./memMetaRoot","./memMetaObj","./memMetaObjFields","./memMetaObjCols"],function(Event,MemCollection,MemObj,MemMetaRoot,MemMetaObj,MemMetaObjFields,MemMetaObjCols){var metaObjFieldsGuid="0fa90328-4e86-eba7-b12b-4fff3a057533",metaObjColsGuid="99628583-1667-3341-78e0-fb2af29dbe8",metaRootGuid="fc13e2b8-3600-b537-f9e5-654b7418c156",metaObjGuid="4dcd61c3-3594-7456-fd86-5a3527c5cdcc",MemDataBase=Class.extend({init:function(controller,params,cb){var pvt=this.pvt={};if(pvt.name=params.name,pvt.robjs=[],pvt.rcoll={},pvt.objs={},pvt.logIdx=[],pvt.$idCnt=0,pvt.subscribers={},pvt.inTran=!1,pvt.guid="guid"in params?params.guid:controller.guid(),pvt.counter=0,pvt.controller=controller,pvt.controller.createLocalProxy(this),pvt.defaultCompCallback=null,pvt.version=0,pvt.validVersion=0,pvt.sentVersion=0,this.event=new Event,"master"!=params.kind){var db=this;controller._subscribe(this,params.proxyMaster,function(result){pvt.proxyMaster=controller.getProxy(params.proxyMaster.guid),pvt.version=result.data.dbVersion,pvt.validVersion=pvt.version,pvt.sentVersion=pvt.version,controller.subscribeRoots(db,"fc13e2b8-3600-b537-f9e5-654b7418c156",function(){db._buildMetaTables(),void 0!==cb&&"function"==typeof cb&&cb()})})}else pvt.meta=new MemMetaRoot({db:this},{}),void 0!==cb&&"function"==typeof cb&&cb(this)},_addRoot:function(obj,opt){var root=this.getRoot(obj.getGuid());root?root.obj=obj:(root={},root.obj=obj,root.mode=opt.mode,root.type=opt.type,root.subscribers={},root.master=null,root.dver=0,root.sver=0,root.vver=0,root.callbackNewObject=void 0,root.event=new Event,this.pvt.robjs.push(root),this.pvt.rcoll[obj.getGuid()]=root),this.event.fire({type:"newRoot",target:obj})},_addObj:function(obj){this.pvt.objs[obj.getGuid()]=obj},_addLogItem:function(item){this.pvt.logIdx.push(item)},_buildMetaTables:function(){for(var metacol=this.getMeta().getCol("MetaObjects"),i=0;i<metacol.count();i++){var o=metacol.get(i);void 0==o.pvt.fieldsTable&&o._bldElemTable()}},_cbSetNewObject:function(rootGuid,callback){this.getRoot(rootGuid).callbackNewObject=callback
},_cbGetNewObject:function(rootGuid){return this.getRoot(rootGuid).callbackNewObject},getRootGuids:function(rootKind){for(var guids=[],ro=this.pvt.robjs,i=0;i<ro.length;i++){var cguid=ro[i].obj.getGuid();cguid==metaRootGuid||ro[i].type!=rootKind&&void 0!==rootKind&&"all"!==rootKind||guids.push(cguid)}return guids},onDeleteObject:function(obj){var root=this.getRoot(obj.getRoot().getGuid());delete this.pvt.objs[obj.getGuid()],this.event.fire({type:"delObj",target:obj}),root.event.fire({type:"delObj",target:obj})},subscribeRoots:function(rootGuid,callback,callback2){this.pvt.controller.subscribeRoots(this,rootGuid,callback,callback2)},onSubscribe:function(proxy){this.pvt.subscribers[proxy.guid]=proxy,console.log(this.getGuid()),this.prtSub(this.pvt)},isSubscribed:function(dbGuid){var s=this.pvt.subscribers[dbGuid];return s?s:null},onUnsubscribe:function(connectId){for(var g in this.pvt.subscribers){var p=this.pvt.subscribers[g];p.connect.getId()==connectId&&delete this.pvt.subscribers[g]}for(g in this.pvt.rcoll){var p=this.pvt.rcoll[g];for(var g2 in p.subscribers)p.subscribers[g2].connect.getId()==connectId&&delete p.subscribers[g2]}},onSubscribeRoots:function(dbGuid,rootGuids){var rg=[],res=[];Array.isArray(rootGuids)?rg=rootGuids:"res"==rootGuids||"data"==rootGuids||"all"==rootGuids?rg=this.getRootGuids(rootGuids):rg.push(rootGuids);for(var i=0;i<rg.length;i++)if(this.pvt.robjs.length>0){var ro=this.pvt.rcoll[rg[i]];if(ro){var subProxy=this.pvt.subscribers[dbGuid];if(subProxy){var clog=ro.obj.getLog();clog.getActive()||clog.setActive(!0),ro.subscribers[dbGuid]=subProxy,res.push(this.serialize(ro.obj))}}}return this.pvt.controller.genDeltas(this.getGuid()),res},prtSub:function(root){console.log("***");for(var guid in root.subscribers)console.log(guid+"  "+root.subscribers[guid].connect.name())},serialize:function(obj){if(!("getDB"in obj)||obj.getDB()!=this)return null;var newObj={};newObj.$sys={},newObj.$sys.guid=obj.getGuid(),newObj.ver=obj.getRootVersion(),newObj.$sys.typeGuid=obj.getTypeGuid(),newObj.fields={};for(var i=0;i<obj.count();i++)newObj.fields[obj.getFieldName(i)]=obj.get(i);for(newObj.collections={},i=0;i<obj.countCol();i++)for(var cc=obj.getCol(i),cc2=newObj.collections[cc.getName()]={},j=0;j<cc.count();j++){var o2=this.serialize(cc.get(j));cc2[j]=o2}return newObj},deserialize:function(sobj,parent,cb){function ideser(that,sobj,parent){switch("obj"in parent||(parent.db=that),sobj.$sys.typeGuid){case metaObjFieldsGuid:var o=new MemMetaObjFields(parent,sobj);break;case metaObjColsGuid:o=new MemMetaObjCols(parent,sobj);break;case metaRootGuid:that.pvt.meta=new MemMetaRoot(parent,sobj),o=that.pvt.meta;break;case metaObjGuid:o=new MemMetaObj(parent,sobj);break;default:var typeObj=that.getObj(sobj.$sys.typeGuid);"obj"in parent||(parent.nolog=!0),o=new MemObj(typeObj,parent,sobj),typeObj&&"res"==typeObj.getRtype()&&void 0!=cb&&cb(o)}for(var cn in sobj.collections)for(var co in sobj.collections[cn])ideser(that,sobj.collections[cn][co],{obj:o,colName:cn});return o}"obj"in parent&&parent.obj.getLog().setActive(!1);var res=ideser(this,sobj,parent),rholder=this.getRoot(res.getGuid());return rholder&&("ver"in sobj?(rholder.vver=sobj.ver,rholder.sver=sobj.ver,rholder.dver=sobj.ver):(rholder.vver=0,rholder.sver=0,rholder.dver=0)),res.getLog().setActive(!0),res},setDefaultCompCallback:function(cb){this.pvt.defaultCompCallback=cb},getDefaultCompCallback:function(){return this.pvt.defaultCompCallback},addRoots:function(sobjs,cb,subDbGuid){var res=[];this.getCurrentVersion(),cb||(cb=this.getDefaultCompCallback());for(var i=0;i<sobjs.length;i++){var croot=this.deserialize(sobjs[i],{},cb),serializedObj=this.serialize(croot),o={adObj:serializedObj,obj:croot,type:"newRoot"};croot.getLog().add(o);var allSubs=this.getSubscribers();for(var guid in allSubs){var subscriber=allSubs[guid];"remote"==subscriber.kind&&("87510077-53d2-00b3-0032-f1245ab1b74d"==croot.getTypeGuid()||subDbGuid==subscriber.guid)&&(this.pvt.rcoll[croot.getGuid()].subscribers[subscriber.guid]=subscriber)}res.push(croot)}return this.inTran()||(this.setVersion("valid",this.getVersion()),this.getController().genDeltas(this.getGuid())),console.log("SERVER VERSION "+this.getVersion()),res},getController:function(){return this.pvt.controller},getName:function(){return this.pvt.name},getVersion:function(verType){switch(verType){case"sent":return this.pvt.sentVersion;case"valid":return this.pvt.validVersion;default:return this.pvt.version}},setVersion:function(verType,val){switch(verType){case"sent":val<=this.pvt.version?this.pvt.sentVersion=val:(console.log("*** sent setversion error"),console.log("VALID:"+this.getVersion("valid")+"draft:"+this.getVersion()+"sent:"+this.getVersion("sent")));break;case"valid":this.pvt.validVersion=val,console.log("*** valid setversion "+val),this.pvt.version<this.pvt.validVersion&&(this.pvt.version=this.pvt.validVersion);break;default:val>=this.pvt.validVersion&&val>=this.pvt.sentVersion?this.pvt.version=val:(console.log("*** draft setversion error"),console.log("VALID:"+this.getVersion("valid")+"draft:"+this.getVersion()+"sent:"+this.getVersion("sent")))}},getCurrentVersion:function(){var sver=this.getVersion("sent"),ver=this.getVersion();return ver==sver&&this.setVersion("draft",this.getVersion()+1),this.getVersion()},inTran:function(){return this.pvt.inTran},countRoot:function(){return this.pvt.robjs.length},getRoot:function(id){return"number"==typeof id?this.pvt.robjs[id]:this.pvt.rcoll[id]},isMaster:function(){return void 0==this.pvt.proxyMaster?!0:!1},getProxyMaster:function(){return this.pvt.proxyMaster},getMeta:function(){return this.pvt.meta},getNewLid:function(){return this.pvt.$idCnt++},getNewCounter:function(){return this.pvt.counter++},getSubscribers:function(){return this.pvt.subscribers},getObj:function(guid){return this.pvt.objs[guid]},newRootObj:function(objType,flds){if(this.isMaster()){var obj=new MemObj(objType,{db:this,mode:"RW"},flds);return obj}return null},undo:function(version){if(console.log("****************************************  UNDO MODIFICATIONS!!!!!!!!!!"),version<this.getVersion("valid"))return!1;for(var i=0;i<this.countRoot();i++)this.getRoot(i).obj.getLog().undo(version);return this.getVersion("sent")>version&&this.setVersion("sent",version),this.setVersion("draft",version),!0},genDeltas:function(){for(var allDeltas=[],i=0;i<this.countRoot();i++){var d=this.getRoot(i).obj.getLog().genDelta();null!=d&&allDeltas.push(d)}return this.isMaster()&&this.setVersion("valid",this.getVersion()),(allDeltas.length>0||this.isMaster()&&this.getVersion("valid")!=this.getVersion("sent"))&&allDeltas.push({last:1,dbVersion:this.getVersion()}),allDeltas},applyDeltas:function(){},getGuid:function(){return this.pvt.guid},resetModifLog:function(){for(var g in this.pvt.objs)this.getObj(g).resetModifFldLog()}});return MemDataBase}),define("memDB/memDBController",["./memDataBase","../system/event"],function(MemDataBase,Event){var MemDBController=Class.extend({init:function(router){if(this.pvt={},this.pvt.dbCollection={},this.pvt.bufdeltas={},this.event=new Event,router){var that=this;router.add("subscribe",function(){return that.routerSubscribe.apply(that,arguments)}),router.add("unsubscribe",function(){return that.routerUnsubscribe.apply(that,arguments)}),router.add("subscribeRoot",function(){return that.routerSubscribeRoot.apply(that,arguments)}),router.add("subscribeManyRoots",function(){return that.routerSubscribeManyRoots.apply(that,arguments)}),router.add("sendDelta",function(){return that.routerSendDelta.apply(that,arguments)})}},createLocalProxy:function(db){var dbInfo={};return dbInfo.db=db,dbInfo.kind="local",dbInfo.guid=db.getGuid(),this.pvt.dbCollection[db.getGuid()]=dbInfo,dbInfo},findOrCreateProxy:function(proxy){var p=this.getProxy(proxy.guid);if(p)return p;var dbInfo={};return dbInfo.db=null,dbInfo.kind="remote",dbInfo.guid=proxy.guid,dbInfo.connect=proxy.connect,this.pvt.dbCollection[proxy.guid]=dbInfo,dbInfo},routerSubscribe:function(data,done){var result={data:this.onSubscribe({connect:data.connect,guid:data.slaveGuid},data.masterGuid)};done(result)},routerUnsubscribe:function(data,done){this.getDB(data.masterGuid).onUnsubscribe(data.connectId,data.slaveGuid),done({})},routerSubscribeRoot:function(data,done){var masterdb=this.getDB(data.masterGuid);masterdb.isSubscribed(data.slaveGuid)||this.onSubscribe({connect:data.connectId,guid:data.slaveGuid},data.masterGuid);var result={data:masterdb.onSubscribeRoots(data.slaveGuid,data.objGuids)};done(result)},routerSubscribeManyRoots:function(data,done){var masterdb=this.getDB(data.masterGuid);masterdb.isSubscribed(data.slaveGuid)||this.onSubscribe({connect:data.connectId,guid:data.slaveGuid},data.masterGuid);var result={data:masterdb.onSubscribeRoots(data.slaveGuid,data.objGuids)};done(result)},routerSendDelta:function(data,done){console.time("applyDeltas"),this.applyDeltas(data.dbGuid,data.srcDbGuid,data.delta),console.timeEnd("applyDeltas"),console.log("VALID:"+this.getDB(data.dbGuid).getVersion("valid")+"draft:"+this.getDB(data.dbGuid).getVersion()+"sent:"+this.getDB(data.dbGuid).getVersion("sent")),done({data:{dbVersion:this.getDB(data.dbGuid).getVersion()}}),this.event.fire({type:"end2ApplyDeltas",target:this,db:this.getDB(data.dbGuid)})},guid:function(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()},newDataBase:function(init,cb){return new MemDataBase(this,init,cb)},delDataBase:function(guid,cb){var db=this.getDB(guid);if(void 0!=db)if(db.isMaster())delete this.pvt.dbCollection[guid];else{var master=db.getProxyMaster(),that=this;"remote"==master.kind?master.connect.send({action:"unsubscribe",type:"method",slaveGuid:guid,masterGuid:master.guid},function(){delete that.pvt.dbCollection[guid],void 0!==cb&&"function"==typeof cb&&cb()}):(this.onUnsubscribe(p.connect,guid),delete this.pvt.dbCollection[guid],void 0!==cb&&"function"==typeof cb&&cb())}},_subscribe:function(db,proxyMaster,cb){var p=this.findOrCreateProxy(proxyMaster);"remote"==p.kind?p.connect.send({action:"subscribe",type:"method",slaveGuid:db.getGuid(),masterGuid:p.guid},cb):(this.onSubscribe(this.getProxy(db.getGuid()),p.db.getGuid()),void 0!==cb&&"function"==typeof cb&&cb())},onSubscribe:function(proxy,masterGuid){var p=this.findOrCreateProxy(proxy);return db=this.getDB(masterGuid),db.onSubscribe(p),{dbVersion:db.getVersion()}},subscribeRoots:function(db,rootGuids,cb,cb2){cb2||(cb2=db.getDefaultCompCallback());var p=db.getProxyMaster();if("local"==p.kind){for(var newObjs=p.db.onSubscribeRoots(db.getGuid(),rootGuids),rootGuids=[],i=0;i<newObjs.length;i++){var o=db.deserialize(newObjs[i],{mode:"RW"},cb2);rootGuids.push(o.getGuid()),void 0!==cb2&&db._cbSetNewObject(o.getGuid(),cb2)}void 0!==cb&&"function"==typeof cb&&cb(rootGuids)}else callback2=function(obj){for(var rootGuids=[],i=0;i<obj.data.length;i++)o=db.deserialize(obj.data[i],{mode:"RW"},cb2),rootGuids.push(o.getGuid()),void 0!==cb2&&db._cbSetNewObject(o.getGuid(),cb2);void 0!==cb&&"function"==typeof cb&&cb(rootGuids)},p.connect.send({action:"subscribeManyRoots",type:"method",slaveGuid:db.getGuid(),masterGuid:p.guid,objGuids:rootGuids},callback2)},onUnsubscribe:function(connect,dbGuid){},getDB:function(guid){var dbInfo=this.pvt.dbCollection[guid];return dbInfo&&"local"==dbInfo.kind?dbInfo.db:null},getProxy:function(dbGuid){return this.pvt.dbCollection[dbGuid]},onDisconnect:function(connectId){for(var i in this.pvt.dbCollection)this.pvt.dbCollection[i].db&&this.pvt.dbCollection[i].db.onUnsubscribe(connectId)},applyDeltas:function(dbGuid,srcDbGuid,delta){console.log("incoming delta: "),console.log(delta);var db=this.getDB(dbGuid),buf=this.pvt.bufdeltas;srcDbGuid in buf||(buf[srcDbGuid]={}),dbGuid in buf[srcDbGuid]||(buf[srcDbGuid][dbGuid]={});var cur=buf[srcDbGuid][dbGuid],tr=delta.dbVersion.toString();if(tr in cur||(cur[tr]=[]),cur[tr].push(delta),"last"in delta){for(var i=0;i<cur[tr].length;i++){var cdelta=cur[tr][i];if("last"in cdelta){0==db.isMaster()&&srcDbGuid==db.getProxyMaster().guid?(db.setVersion("valid",cdelta.dbVersion),db.setVersion("sent",cdelta.dbVersion)):(db.setVersion("valid",cdelta.dbVersion),db.setVersion("sent",cdelta.dbVersion));break}var root=db.getRoot(cdelta.rootGuid);if(cdelta.items[0].newRoot)var rootObj=db.deserialize(cdelta.items[0].newRoot,{},db.getDefaultCompCallback());else rootObj=root.obj;rootObj.getLog().applyDelta(cdelta),console.log("VALID:"+db.getVersion("valid")+"draft:"+db.getVersion()+"sent:"+db.getVersion("sent"))}this.propagateDeltas(dbGuid,srcDbGuid,cur[tr]),delete cur[tr],this.event.fire({type:"endApplyDeltas",target:this,db:db})}},genDeltas:function(dbGuid){var db=this.getDB(dbGuid),deltas=db.genDeltas();deltas.length>0&&(this.propagateDeltas(dbGuid,null,deltas),db.getVersion("sent")<db.getVersion()&&db.setVersion("sent",db.getVersion()))},propagateDeltas:function(dbGuid,srcDbGuid,deltas){function cb(result){console.log("CALLBACK PROPAGATE DELTAS"),console.log(result)}for(var db=this.getDB(dbGuid),i=0;i<deltas.length;i++){var delta=deltas[i];if(srcDbGuid!=db.getGuid()){var proxy=db.getProxyMaster();void 0!=proxy&&proxy.guid!=srcDbGuid&&("local"==proxy.kind||(console.log("sending delta db: "+db.getGuid()),console.log(delta),proxy.connect.send({action:"sendDelta",type:"method",delta:delta,dbGuid:proxy.guid,srcDbGuid:db.getGuid()},cb)))}if("last"in delta){var allSubs=db.getSubscribers();for(var guid in allSubs){var subscriber=allSubs[guid];"remote"==subscriber.kind&&srcDbGuid!=guid&&(subscriber.connect.send({action:"sendDelta",delta:delta,dbGuid:subscriber.guid,srcDbGuid:db.getGuid()}),console.log("sent last to DB : "+subscriber.guid))}}else{var root=db.getRoot(delta.rootGuid);for(guid in root.subscribers)subscriber=root.subscribers[guid],"remote"==subscriber.kind&&srcDbGuid!=guid&&(subscriber.connect.send({action:"sendDelta",delta:delta,dbGuid:subscriber.guid,srcDbGuid:db.getGuid()}),console.log("sent to DB : "+subscriber.guid))}}}});return MemDBController}),define("system/graphset",[],function(){var Graphset=Class.extend({init:function(){this.pvt={},this.pvt.pts={},this.pvt.sPts={},this.pvt.ePts={}},_addPoint:function(id,obj){if(this.pvt.pts[id])return!1;var p={};return p.obj=obj,p.id=id,p.inLinks={},p.outLinks={},this.pvt.pts[id]=p,this.pvt.sPts[id]=p,this.pvt.ePts[id]=p,!0},_addLink:function(fromId,toId,cb){if(!this.pvt.pts[fromId]&&this.pvt.pts[toId])return!1;var l={};l.fromPt=this.pvt.pts[fromId],l.toPt=this.pvt.pts[toId],l.fromPt.outLinks[toId]=l,l.toPt.inLinks[fromId]=l,l.cb=cb,this.pvt.sPts[toId]&&delete this.pvt.sPts[toId],this.pvt.ePts[fromId]&&delete this.pvt.ePts[fromId]},_delPoint:function(){},_delLink:function(){},getPt:function(id){return this.pvt.pts[id]?this.pvt.pts[id]:void 0},on:function(subsId,publId,cb){this.getPt(subsId)||this._addPoint(subsId,null),this.getPt(publId)||this._addPoint(publId,null),this.addLink(publId,subsId,cb)},fire:function(id,result){var p=this.getPt(id);if(!p)return!1;for(var i in p.outLinks)p.outLinks[i].cb.callback.apply(cb.context,result)}});return Graphset}),define("system/rpc",[],function(){var defineProxyClass=function(){function createProxyFunction(functionName){return function(){var pholder=this.pvt.proxy,cb=null;if(arguments.length>0){var lastArg=arguments[arguments.length-1];if("function"==typeof lastArg){for(var newArgs=[],i=0;i<arguments.length-1;i++)newArgs.push(arguments[i]);cb=lastArg}else newArgs=arguments}else newArgs=[];if(!this.pvt.proxy.connect){var realObject=this.pvt.proxy.obj,realFunction=realObject[functionName],result=realFunction.apply(realObject,arguments);return result}var params={action:"remoteCall",type:"method",func:functionName,guidIntf:pholder.guidIntf,guidObj:pholder.guidObj,args:newArgs};"function"==typeof lastArg?this.pvt.proxy.connect.send(params,lastArg):this.pvt.proxy.connect.send(params)}}function createProxyClass(intfObj){var proxyClass;proxyClass=function(proxy){this.pvt={},this.pvt.proxy=proxy};for(var functionName in intfObj)if("constructor"!=functionName&&"_"!=functionName.substr(0,1)){{intfObj[functionName]}"function"===intfObj[functionName]&&(proxyClass.prototype[functionName]=createProxyFunction(functionName))}return proxyClass}return function(classObj){var proxyClass=createProxyClass(classObj);return proxyClass}}(),Rpc=Class.extend({init:function(params){if(this.pvt={},this.pvt.intfs={},this.pvt.proxies={},params.router){var that=this,onCall=that.onRemoteCall;params.router.add("remoteCall",function(){return onCall.apply(that,arguments)})}},onRemoteCall:function(data,done){var gi=data.guidIntf,go=data.guidObj,p=this.pvt.intfs[gi][go];if(p){data.args.push(done);var r=p.proxy[data.func].apply(p.proxy,data.args)}"XXX"!=r&&done(r)},_publ:function(obj,intf){if(void 0==this.pvt.intfs[intf.classGuid]){var p=this.pvt.intfs[intf.classGuid]={};p.cproxy=defineProxyClass(intf)}p=this.pvt.intfs[intf.classGuid];var co=p[obj.getGuid()]={};return co.obj=obj,co.connect=null,co.guidIntf=intf.classGuid,co.proxy=new p.cproxy(co),this.pvt.proxies[obj.getGuid()]=co,co.proxy},_publProxy:function(guid,connect,intf){if(void 0==this.pvt.intfs[intf.classGuid]){var p=this.pvt.intfs[intf.classGuid]={};p.cproxy=defineProxyClass(intf)}p=this.pvt.intfs[intf.classGuid];var co=p[guid]={};return co.connect=connect,co.guidObj=guid,co.guidIntf=intf.classGuid,co.proxy=new p.cproxy(co),this.pvt.proxies[guid]=co,co.proxy},_free:function(){},getProxy:function(guid){return this.pvt.proxies[guid]}});return Rpc}),define("system/umodule",["./uobject"],function(UObject){var UModule=UObject.extend({className:"UModule",classGuid:UCCELLO_CONFIG.classGuids.UModule,metaFields:[{fname:"Id",ftype:"int"},{fname:"Name",ftype:"string"},{fname:"Mode",ftype:"string"}],init:function(cm,params){if(this._super(cm,params),cm&&params)if(params&&"db"in params)this.pvt.mydb=params.db;else{if(null==cm)return void(this.pvt.mydb=null);this.pvt.mydb=cm.getDB()}},isMaster:function(){return this.pvt.mydb.isMaster()},isModule:function(){return!0},id:function(value){return this._genericSetter("Id",value)},name:function(value){return this._genericSetter("Name",value)},mode:function(value){return this._genericSetter("Mode",value)}});return UModule});var Utils={};Utils.guid=function(){function s4(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()},module&&(module.exports=Utils),define("system/utils",function(){}),define("uccelloClt",["./connection/clientConnection","./memDB/memDBController","./memDB/memDataBase","./controls/controlMgr","./system/uobject","./system/umodule","./controls/aComponent","./connection/userinfo","./connection/user","./connection/sessioninfo","./connection/session","./connection/connectinfo","./connection/connect","./connection/vc","./system/rpc"],function(ClientConnection,MemDBController,MemDataBase,ControlMgr,UObject,UModule,AComponent,UserInfo,User,SessionInfo,Session,ConnectInfo,Connect,VisualContext,Rpc){var UccelloClt=Class.extend({init:function(options){var that=this;this.pvt={},this.pvt.user=null,this.pvt.sessionGuid=null;var rpc=this.pvt.rpc=new Rpc({router:this.pvt.router}),clt=this.pvt.clientConnection=new ClientConnection(null,{newTabCallback:options.newTabCallback});this.pvt.typeGuids={},this.pvt.dbcontext=null,this.pvt.controlMgr={},this.pvt.vc=null,this.pvt.clientContextId=0,this.options=options,that.pvt.sessionGuid=$.cookie("sid")?$.cookie("sid"):null,this.loadControls(function(){that.getClient().connect(options.host,{guid:that.getSessionGuid()},function(result){$.cookie("sid",result.session.guid),that.pvt.sessionId=result.session.id,that.pvt.sessionGuid=result.session.guid,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.UserInfo]=UserInfo,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.SessionInfo]=SessionInfo,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.ConnectInfo]=ConnectInfo,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.User]=User,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.Session]=Session,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.Connect]=Connect,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.VisualContext]=VisualContext,that.pvt.typeGuids[UCCELLO_CONFIG.classGuids.ClientConnection]=ClientConnection,that.createController(function(){result.user?(that.getClient().authenticated=result.user,that.subscribeUser(options.callback)):options.callback()}),that.pvt.clientConnection.socket.send({action:"testIntf",type:"method"},function(result){var guidServer="d3d7191b-3b4c-92cc-43d4-a84221eb35f5";that.pvt.servInterface=result.intf,that.pvt.proxyServer=rpc._publProxy(guidServer,clt.socket,result.intf)})})})},createController:function(done){var that=this;this.pvt.clientConnection.socket.send({action:"getGuids",type:"method"},function(result){that.pvt.guids=result,that.pvt.controller=new MemDBController,that.pvt.controller.event.on({type:"endApplyDeltas",subscriber:this,callback:function(){var context=that.getContext();context&&context.renderAll(!0)}}),that.pvt.dbsys=that.pvt.controller.newDataBase({name:"System",proxyMaster:{connect:that.pvt.clientConnection.socket,guid:that.pvt.guids.masterSysGuid}},done),that.pvt.cmsys=new ControlMgr(that.pvt.dbsys,null,null,that.pvt.clientConnection.socket),that.pvt.dbclient=that.pvt.controller.newDataBase({name:"MasterClient",kind:"master"}),that.pvt.cmclient=new ControlMgr(that.pvt.dbclient,null,null,that.pvt.clientConnection.socket),new UObject(that.pvt.cmclient),new UModule(that.pvt.cmclient),new AComponent(that.pvt.cmclient),new VisualContext(that.pvt.cmclient),new ClientConnection(that.pvt.cmclient),that.pvt.clientConnection.init(that.pvt.cmclient,{})})},getClient:function(){return this.pvt.clientConnection},getController:function(){return this.pvt.controller},getSysDB:function(){return this.pvt.dbsys},getClientDB:function(){return this.pvt.dbclient},getClientCM:function(){return this.pvt.cmclient},getSysCM:function(){return this.pvt.cmsys},getContext:function(){return this.pvt.vc},getContextCM:function(){return this.pvt.vc.getContextCM()},getConstr:function(guid){return this.pvt.typeGuids[guid]},addConstr:function(obj){this.pvt.typeGuids[obj.classGuid]=obj},getUser:function(){return this.pvt.user},getSessionGuid:function(){return this.pvt.sessionGuid},createContext:function(side,formGuids,cbfinal){if("server"==side){this._createSrvContext(formGuids,function(result){result.side="server",cbfinal(result)})}else{var contextId=++this.pvt.clientContextId,params={parent:this.getClient(),colName:"VisualContext",ini:{fields:{Id:contextId,Name:"context"+contextId,Kind:"master"}},formGuids:formGuids,rpc:this.pvt.rpc,proxyServer:this.pvt.proxyServer,components:this.pvt.components},context=new VisualContext(this.pvt.cmclient,params),result={masterGuid:this.getClientDB().getGuid(),vc:context.getGuid(),side:"client",formGuids:formGuids};cbfinal(result)}},_createSrvContext:function(formGuids,callback){this.getClient().socket.send({action:"createContext",type:"method",formGuids:formGuids},callback)},setContext:function(params,cbfinal,renderRoot){function cbfinal2(result2){result2=result2&&result2.guids?result2.guids:result2,that.getContext().renderForms(result2,!0),cbfinal&&cbfinal(result2)}var that=this,s=that.pvt.clientConnection.socket,p={socket:s,proxyServer:that.pvt.proxyServer};p.formGuids=params.formGuids,p.components=that.pvt.components,"client"==params.side?(that.pvt.vc=this.pvt.cmclient.getByGuid(params.vc),that.pvt.vc.on(this.pvt.cmclient,p,cbfinal2,renderRoot)):(that.pvt.vc=that.pvt.cmsys.getByGuid(params.vc),that.pvt.vc.on(that.pvt.cmsys,p,cbfinal2,renderRoot))},createRoot:function(formGuids,rtype,callback){var that=this;this.getContext().loadNewRoots(formGuids,{rtype:rtype,subDbGuid:this.getContext().getDB().getGuid()},function(result){that.getContext().renderForms(result.guids,!0),callback&&callback(result)})},loadControls:function(callback){for(var that=this,scripts=[],ctrls=UCCELLO_CONFIG.controls,i=0;i<ctrls.length;i++){var path=ctrls[i].isUccello?UCCELLO_CONFIG.uccelloPath:UCCELLO_CONFIG.controlsPath;if(scripts.push(path+ctrls[i].component),UCCELLO_CONFIG.viewSet&&ctrls[i].viewset){var c=ctrls[i].className;scripts.push(UCCELLO_CONFIG.viewSet.path+"v"+c.charAt(0).toLowerCase()+c.slice(1))}}that.pvt.components={},require(scripts,function(){for(var argIndex=0,i=0;i<ctrls.length;i++){var className=ctrls[i].className;that.pvt.components[className]={module:arguments[argIndex],viewsets:{}},argIndex++,UCCELLO_CONFIG.viewSet&&ctrls[i].viewset&&(that.pvt.components[className].viewsets[UCCELLO_CONFIG.viewSet.name]=arguments[argIndex],argIndex++)}callback()})},subscribeUser:function(callback){var user=this.getClient().authenticated;if(!user)return void callback(!1);this.pvt.sessionGuid=user.session.guid,this.pvt.sessionId=user.session.id,this.pvt.guids.sysRootGuid=user.guid;var that=this,compCallBack=function(obj){var classGuid=obj.getTypeGuid(),transArr={};transArr[UCCELLO_CONFIG.classGuids.User]=UCCELLO_CONFIG.classGuids.UserInfo,transArr[UCCELLO_CONFIG.classGuids.Connect]=UCCELLO_CONFIG.classGuids.ConnectInfo,transArr[UCCELLO_CONFIG.classGuids.Session]=UCCELLO_CONFIG.classGuids.SessionInfo,classGuid=transArr[classGuid]?transArr[classGuid]:classGuid;var params={objGuid:obj.getGuid()},component=new(that.getConstr(classGuid))(that.pvt.cmsys,params);classGuid==UCCELLO_CONFIG.classGuids.UserInfo&&(that.pvt.user=component)};this.getSysDB().setDefaultCompCallback(compCallBack),this.getSysDB().subscribeRoots(this.pvt.guids.sysRootGuid,callback,compCallBack)},deauthenticate:function(callback){var that=this;that.getClient().deauthenticate(function(result){that.pvt.sessionGuid=result.user.session.guid,that.pvt.sessionId=result.user.session.id,that.pvt.guids.sysRootGuid=result.user.guid,that.getSysDB().subscribeRoots(that.pvt.guids.sysRootGuid,callback)})}});return UccelloClt}),require([""]);